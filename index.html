<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rihaakuru Island</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Custom font for Dhivehi */
        @font-face {
            font-family: 'Faruma';
            src: url('fonts/Mv_MAG_Round_XBold.otf');
        }

        /* Custom font for the header */
        @font-face {
            font-family: 'SameeAvasThaana';
            src: url('fonts/Samee_Avas_Thaana.ttf');
        }
        
        /* Login Screen Styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo {
            margin-bottom: 20px;
        }
        
        .login-logo i {
            font-size: 3rem;
            color: #1a2a6c;
            margin-bottom: 10px;
        }
        
        .login-logo h1 {
            font-size: 2rem;
            color: #1a2a6c;
            font-family: 'SameeAvasThaana', sans-serif;
        }
        
        .login-form {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1a2a6c;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #1a2a6c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #2a3b7c;
        }
        
        .user-management {
            margin-top: 20px;
            text-align: center;
        }
        
        .user-list {
            margin-top: 15px;
            text-align: left;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        /* Full screen button */
        .fullscreen-btn {
            position: absolute;
            left: 70px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .fullscreen-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Exit Full Screen Button */
        .exit-fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1a2a6c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        
        body.fullscreen-mode .exit-fullscreen-btn {
            display: block;
        }
        
        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            transition: opacity 0.5s ease-out;
        }
        
        .splash-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        .splash-logo i {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        .splash-logo h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            font-family: 'SameeAvasThaana', sans-serif;
        }
        
        .splash-logo p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .progress-bar {
            width: 80%;
            max-width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            width: 0%;
            background: white;
            border-radius: 3px;
            transition: width 2s ease-in-out;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Main App Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 10px;
            color: #333;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        header {
            background: #1a2a6c;
            color: white;
            padding: 12px;
            text-align: center;
            position: relative;
        }
        
        .menu-toggle {
            position: absolute;
            left: 15px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
        }
        
        .logo i {
            font-size: 2.2rem;
            margin-right: 8px;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-family: 'SameeAvasThaana', sans-serif;
        }
        
        .tabs {
            display: flex;
            background: #0d1b4b;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 10px 12px;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            min-width: 100px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .tab.active {
            background: #fdbb2d;
            color: #1a2a6c;
        }
        
        .tab:hover:not(.active) {
            background: #2a3b7c;
        }
        
        .content {
            padding: 15px;
        }
        
        .form-section, .pos-section, .island-section, .payment-section, .product-section, .dashboard-section, .trip-section, .user-section, .admin-section {
            display: none;
        }
        
        .form-section.active, .pos-section.active, .island-section.active, .payment-section.active, .product-section.active, .dashboard-section.active, .trip-section.active, .user-section.active, .admin-section.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -5px 10px;
        }
        
        .form-group {
            flex: 1 0 100%;
            margin: 0 5px 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1a2a6c;
            font-size: 13px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1a2a6c;
            outline: none;
        }
        
        .product-details {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .product-header {
            display: none;
            flex-wrap: wrap;
            margin-bottom: 10px;
            font-weight: bold;
            color: #1a2a6c;
            padding: 0 5px;
            font-size: 13px;
        }
        
        .product-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            align-items: center;
            background: white;
            padding: 8px;
            border-radius: 8px;
            position: relative;
        }
        
        .product-name {
            flex: 1 0 100%;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-unit {
            flex: 1;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-qty {
            flex: 1;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-price {
            flex: 1;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-desc {
            flex: 1 0 100%;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-actions {
            flex: 1;
            padding: 0 5px;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1a2a6c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2a3b7c;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-sm {
            padding: 6px 8px;
            font-size: 12px;
        }
        
        .btn-xs {
            padding: 4px 6px;
            font-size: 11px;
        }
        
        .payment-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .payment-status label {
            margin-right: 10px;
            margin-bottom: 5px;
            font-family: 'Faruma';
        }
        
        .payment-status input {
            width: auto;
            margin-right: 5px;
        }
        
        .status-radio {
            display: flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }
        
        .actions {
            text-align: center;
            margin-top: 15px;
        }
        
        /* Island Management Styles */
        .island-management, .product-management {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .island-form, .product-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .island-form input, .product-form input {
            flex: 1;
            min-width: 120px;
        }
        
        .island-list, .product-list {
            background: white;
            border-radius: 8px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .island-item, .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .island-item:last-child, .product-item:last-child {
            border-bottom: none;
        }
        
        /* POS System Styles */
        .island-selector {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .island-selector select {
            max-width: 100%;
            margin: 0 auto 10px;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
        }
        
        .pos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .trip-list {
            flex: 1;
            min-width: 100%;
            background: #f5f7ff;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .trip-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .trip-card.selected {
            border: 2px solid #1a2a6c;
            background: #e6e9ff;
        }
        
        .trip-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        
        .trip-island {
            font-weight: bold;
            color: #1a2a6c;
            font-size: 14px;
        }
        
        .trip-date {
            color: #666;
            font-size: 13px;
        }
        
        .trip-customer {
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .trip-products {
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 12px;
        }
        
        .trip-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #ddd;
            flex-wrap: wrap;
        }
        
        .trip-status {
            padding: 3px 6px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .trip-amount {
            font-weight: bold;
            color: #1a2a6c;
            font-size: 14px;
        }
        
        .trip-actions {
            display: flex;
            gap: 6px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .invoice-preview {
            flex: 1;
            min-width: 100%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            font-family: 'SameeAvasThaana', sans-serif;
        }
        
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .invoice-products {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
            min-width: 500px;
        }
        
        .invoice-products th {
            background: #f5f7ff;
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-size: 12px;
        }
        
        .invoice-products td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        
        .invoice-total {
            text-align: right;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            padding: 10px;
            background: #f5f7ff;
            border-radius: 6px;
        }
        
        .invoice-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .bank-details {
            margin-top: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 12px;
        }
        
        /* Payment Management Styles */
        .payment-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .payment-filter {
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .payment-filter.active {
            background: #1a2a6c;
            color: white;
        }
        
        .payment-filter:hover:not(.active) {
            background: #2a3b7c;
            color: white;
        }
        
        .payment-list {
            background: #f5f7ff;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .payment-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .payment-info {
            flex: 2;
            margin-bottom: 8px;
        }
        
        .payment-amount {
            flex: 1;
            text-align: right;
            font-weight: bold;
            font-size: 14px;
            color: #1a2a6c;
            margin-bottom: 8px;
        }
        
        .payment-actions {
            flex: 1;
            text-align: right;
        }
        
        /* Customer Registration Form */
        .customer-registration {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Customer List Styles */
        .customer-list {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .customer-table th, .customer-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .customer-table th {
            background-color: #1a2a6c;
            color: white;
        }
        
        .customer-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Mobile-specific styles */
        .mobile-product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .mobile-product-row {
            display: contents;
        }
        
        /* Dashboard Styles */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background: #f5f7ff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card h3 {
            color: #1a2a6c;
            margin-bottom: 17px;
            font-family: 'Faruma';
        }
        
        .dashboard-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #1a2a6c;
        }
        
        .dashboard-card .subtext {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
             font-family: 'Faruma';
        }
        
        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container h3 {
            color: #1a2a6c;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Date Filter Styles */
        .date-filter {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .date-filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 120px;
        }
        
        /* Mobile sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: #1a2a6c;
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            padding-top: 60px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        
        .sidebar.open {
            left: 0;
            display: block;
        }
        
        .sidebar .tab {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .tab.active {
            background: #fdbb2d;
            color: #1a2a6c;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .overlay.open {
            display: block;
        }
        
        /* Island customers list */
        .island-customers {
            margin-top: 15px;
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
        }
        
        .island-customer-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        
        .island-customer-item:hover {
            background-color: #e6e9ff;
        }
        
        .island-customer-item:last-child {
            border-bottom: none;
        }
        
        .island-total {
            margin-top: 10px;
            padding: 10px;
            background: #1a2a6c;
            color: white;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        
        /* Quick customer registration button */
        .quick-customer-btn {
            margin-top: 15px;
            text-align: center;
        }
        
        /* Trip Management Styles */
        .trip-management {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .trip-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .trip-form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .trip-list-container {
            background: white;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .trip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .trip-item:last-child {
            border-bottom: none;
        }
        
        .trip-info {
            flex: 2;
            font-size: 14px;
        }
        
        .trip-actions {
            flex: 1;
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        /* Product Management Enhancement Styles */
        .product-form-with-fee {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .product-form-with-fee input {
            flex: 1;
            min-width: 120px;
        }
        
        .product-fee-input {
            max-width: 120px;
        }
        
        .product-item-with-fee {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .product-fee-display {
            font-weight: bold;
            color: #1a2a6c;
            margin-left: 10px;
        }
        
        /* User Management Styles */
        .user-management {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .user-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .user-form input {
            flex: 1;
            min-width: 120px;
        }
        
        .user-list {
            background: white;
            border-radius: 8px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        /* Mobile invoice styles */
        @media (max-width: 767px) {
            .invoice-products th:nth-child(4),
            .invoice-products td:nth-child(4) {
                display: none;
            }
            
            .invoice-products th:nth-child(4)::before {
                content: "Boat Fee";
                display: table-cell;
            }
            
            .invoice-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .invoice-actions .btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .customer-table {
                font-size: 11px;
            }
            
            .customer-table th, .customer-table td {
                padding: 5px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .tabs {
                display: none;
            }
            
            .trip-form-group {
                min-width: 100%;
            }
            
            .trip-info {
                font-size: 12px;
            }
            
            .product-form-with-fee input {
                min-width: 100%;
            }
            
            .product-fee-input {
                max-width: 100%;
            }
            
            .fullscreen-btn {
                left: 60px;
                top: 12px;
                font-size: 1rem;
            }
            
            /* Hide header user profile on mobile */
            .user-profile {
                display: none;
            }
            
            /* Show user info in sidebar */
            .sidebar-user-info {
                display: block;
                padding: 15px 20px;
                background: rgba(255,255,255,0.1);
                margin-bottom: 10px;
                text-align: center;
            }
            
            .sidebar-user-name {
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .sidebar-user-role {
                font-size: 12px;
                opacity: 0.8;
            }
        }
        
        /* Print styles for invoice */
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-preview, .invoice-preview * {
                visibility: visible;
            }
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
            .invoice-actions {
                display: none;
            }
        }
        
        /* Media queries for larger screens */
        @media (min-width: 768px) {
            body {
                padding: 15px;
                font-size: 16px;
            }
            
            .container {
                max-width: 95%;
            }
            
            header {
                padding: 15px;
            }
            
            .logo i {
                font-size: 3rem;
            }
            
            h1 {
                font-size: 2.8rem;
            }
            
            .tab {
                font-size: 14px;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-group {
                flex: 1 0 calc(50% - 10px);
            }
            
            .product-header {
                display: flex;
            }
            
            .product-name, .product-unit, .product-qty, .product-price, .product-desc, .product-actions {
                margin-bottom: 0;
                flex: 1;
            }
            
            .product-name {
                flex: 2;
            }
            
            .product-desc {
                flex: 2;
            }
            
            .trip-list, .invoice-preview {
                min-width: calc(50% - 8px);
            }
            
            .payment-info, .payment-amount, .payment-actions {
                margin-bottom: 0;
            }
            
            .mobile-product-grid {
                display: block;
            }
            
            /* Hide sidebar user info on desktop */
            .sidebar-user-info {
                display: none;
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                max-width: 1300px;
            }
            
            .form-group {
                flex: 1 0 calc(33.333% - 10px);
            }
        }
        
        /* Total trips value display */
        .total-trips-value {
            background: #1a2a6c;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Customer Selection Styles */
        .customer-selection {
            margin-bottom: 15px;
        }
        
        .customer-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        /* Boat Fee Styles */
        .boat-fee-input {
            display: flex;
            align-items: center;
        }
        
        .boat-fee-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        /* Edit and Delete buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        /* Boat fee display in product form */
        .boat-fee-display {
            background: #e6e9ff;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-weight: bold;
            color: #1a2a6c;
        }
        
        /* Current Trip Info */
        .current-trip-info {
            background: #e6e9ff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #1a2a6c;
        }
        
        /* Unpaid row styling */
        .unpaid-row {
            background-color: #ffe6e6 !important;
        }
        
        .paid-row {
            background-color: #e6ffe6 !important;
        }
        
        /* Payment method styling */
        .payment-method-cell {
            font-weight: bold;
        }
        
        .payment-method-not-paid {
            color: #dc3545;
        }
        
        .payment-method-cash {
            color: #28a745;
        }
        
        .payment-method-transfer {
            color: #17a2b8;
        }
        
        .payment-method-card {
            color: #ffc107;
        }
        
        /* Full screen mode styles */
        body.fullscreen-mode {
            padding: 0;
            background: white;
        }
        
        body.fullscreen-mode .container {
            border-radius: 0;
            height: 100vh;
            overflow: auto;
        }
        
        /* Access Control Styles */
        .access-control {
            margin-top: 20px;
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
        }
        
        .access-control h3 {
            color: #1a2a6c;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .permission-item input {
            width: auto;
            margin-right: 10px;
        }
        
        .permission-item label {
            margin-bottom: 0;
            cursor: pointer;
        }
        
        /* Enhanced PDF Export Styles */
        .pdf-export-options {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .export-option {
            display: flex;
            align-items: center;
        }
        
        .export-option input {
            width: auto;
            margin-right: 8px;
        }
        
        .export-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* User Profile Styles */
        .user-profile {
            position: absolute;
            right: 15px;
            top: 15px;
            display: flex;
            align-items: center;
            color: white;
        }
        
        .user-profile .user-info {
            margin-right: 10px;
            text-align: right;
        }
        
        .user-profile .user-name {
            font-weight: bold;
        }
        
        .user-profile .user-role {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 4px;
            padding: 5px 50px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Admin Panel Styles */
        .admin-panel {
            background: #f5f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .admin-controls button {
            flex: 1;
            min-width: 150px;
        }
        
        .admin-data-view {
            background: white;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Island customer count badge */
        .island-customer-count {
            background: #1a2a6c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-ship"></i>
                <h1>qTOb amAyin</h1>
                <p>Boat Trip Management System</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                
                <button class="login-btn" id="login-btn">Login</button>
                
                <div id="login-message" style="color: red; margin-top: 10px; text-align: center;"></div>
            </div>
            
            <!-- Owner-only user management section -->
            <div class="user-management" id="owner-user-management" style="display: none;">
                <h3>User Management (Owner Only)</h3>
                
                <div class="user-form">
                    <input type="text" id="new-username" placeholder="New username">
                    <input type="password" id="new-password" placeholder="New password">
                    <select id="new-user-role">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button class="btn btn-primary" id="add-user-btn">Add User</button>
                </div>
                
                <div class="access-control">
                    <h3>Access Permissions</h3>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm-dashboard" class="perm-checkbox" data-perm="dashboard" checked>
                            <label for="perm-dashboard">Dashboard</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-trip" class="perm-checkbox" data-perm="trip" checked>
                            <label for="perm-trip">Trip Management</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-form" class="perm-checkbox" data-perm="form" checked>
                            <label for="perm-form">Entry Form</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-pos" class="perm-checkbox" data-perm="pos" checked>
                            <label for="perm-pos">POS System</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-island" class="perm-checkbox" data-perm="island" checked>
                            <label for="perm-island">Island Management</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-product" class="perm-checkbox" data-perm="product" checked>
                            <label for="perm-product">Product Management</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-payment" class="perm-checkbox" data-perm="payment" checked>
                            <label for="perm-payment">Payment Management</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-user" class="perm-checkbox" data-perm="user">
                            <label for="perm-user">User Management</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-admin" class="perm-checkbox" data-perm="admin">
                            <label for="perm-admin">Admin Panel</label>
                        </div>
                    </div>
                </div>
                
                <div class="user-list" id="user-list">
                    <h3>System Users</h3>
                    <!-- Users will be listed here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-ship"></i>
            <h1>qTOb amAyin</h1>
            <p>Boat Trip Management System</p>
        </div>
        <div class="progress-bar">
            <div class="progress" id="splash-progress"></div>
        </div>
    </div>
    
    <!-- Exit Full Screen Button -->
    <button class="exit-fullscreen-btn" id="exit-fullscreen-btn">
        <i class="fas fa-compress"></i>
    </button>
    
    <!-- Mobile Sidebar -->
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-user-info" id="sidebar-user-info">
            <div class="sidebar-user-name" id="sidebar-user-name"></div>
            <div class="sidebar-user-role" id="sidebar-user-role"></div>
        </div>
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="trip">Trip Management</div>
        <div class="tab" data-tab="form">Entry Form</div>
        <div class="tab" data-tab="pos">POS System</div>
        <div class="tab" data-tab="island">Island Management</div>
        <div class="tab" data-tab="product">Product Management</div>
        <div class="tab" data-tab="payment">Payment Management</div>
        <div class="tab" data-tab="user" id="user-management-tab" style="display: none;">User Management</div>
        <div class="tab" data-tab="admin" id="admin-tab" style="display: none;">Admin Panel</div>
        <div class="tab" id="logout-btn" style="color: #ff6b6b;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="container">
        <header>
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Full screen button moved to left side -->
            <button class="fullscreen-btn" id="fullscreen-btn">
                <i class="fas fa-expand"></i>
            </button>
        
            <div class="logo">
                <i class="fas fa-ship"></i>
                <h1>qTOb amAyin</h1>
            </div>
            
            <p>Manage your boat trips, customers, and invoices in one place</p>
            
            <!-- User Profile and Logout -->
            <div class="user-profile" id="user-profile">
                <div class="user-info">
                    <div class="user-name" id="current-user"></div>
                    <div class="user-role" id="user-role"></div>
                </div>
                <button class="logout-btn" id="header-logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="trip">Trip Management</div>
            <div class="tab" data-tab="form">Entry Form</div>
            <div class="tab" data-tab="pos">POS System</div>
            <div class="tab" data-tab="island">Island Management</div>
            <div class="tab" data-tab="product">Product Management</div>
            <div class="tab" data-tab="payment">Payment Management</div>
            <div class="tab" data-tab="user" id="user-tab" style="display: none;">User Management</div>
            <div class="tab" data-tab="admin" id="admin-main-tab" style="display: none;">Admin Panel</div>
        </div>
        
        <div class="content">
            <!-- Dashboard Section -->
            <div class="dashboard-section active" id="dashboard-section">
                <h2>Dashboard</h2>
                <p>Overview of your boat trip business</p>
                
                <!-- Current Trip Info -->
                <div class="current-trip-info" id="current-trip-info">
                    Current Trip: None Selected
                </div>
                
                <!-- Date Filter -->
                <div class="date-filter">
                    <div class="date-filter-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="date-filter-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date">
                    </div>
                    <div class="date-filter-group">
                        <label for="trip-filter">Filter by Trip</label>
                        <select id="trip-filter">
                            <option value="all">All Trips</option>
                            <!-- Trips will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="date-filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="apply-filter">Apply Filter</button>
                    </div>
                    <div class="date-filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-warning" id="reset-filter">Reset Filter</button>
                    </div>
                </div>
                
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h3>ޖުމްލަ މުދާތައް</h3>
                        <div class="value" id="total-products">0</div>
                        <div class="subtext">ހުރިހާ މުދާ ފޯރުކޮށްދެވިފައި</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ޖުމްލަ ކަސްޓަމަރުން</h3>
                        <div class="value" id="total-orders">0</div>
                        <div class="subtext">ހުރިހާ ކަސްޓަމަރުންގެ މުދާ</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ޖުމްލަ އާމްދަނީ</h3>
                        <div class="value" id="total-revenue">RF 0</div>
                        <div class="subtext">ހުރިހާ ދަތުރުތަކުން</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ނުދައްކާހުރި ބިލުތައް</h3>
                        <div class="value" id="pending-bills">RF 0</div>
                        <div class="subtext">ފައިސާ ނުދައްކާ ހުރި ބިލުތައް</div>
                    </div>
                </div>
                
                <div class="dashboard-charts">
                    <div class="chart-container">
                        <h3>Products Distribution</h3>
                        <canvas id="products-chart" height="250"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Island-wise Orders</h3>
                        <canvas id="islands-chart" height="250"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Payment Methods</h3>
                        <canvas id="payment-methods-chart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Trip Management Section -->
            <div class="trip-section" id="trip-section">
                <h2>Trip Management</h2>
                <p>Create and manage boat trips</p>
                
                <div class="trip-management">
                    <div class="trip-form">
                        <div class="trip-form-group">
                            <label for="trip-date">Trip Date</label>
                            <input type="date" id="trip-date" required>
                        </div>
                        <div class="trip-form-group">
                            <label for="trip-number">Trip Number</label>
                            <input type="text" id="trip-number" placeholder="Enter trip number" required>
                        </div>
                        <div class="trip-form-group">
                            <label for="trip-invoice-id">Trip Invoice ID</label>
                            <input type="text" id="trip-invoice-id" placeholder="Enter invoice ID">
                        </div>
                        <div class="trip-form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" id="create-trip-btn">Create New Trip</button>
                        </div>
                    </div>
                    
                    <div class="trip-list-container">
                        <h3>Available Trips</h3>
                        <div id="trip-list">
                            <!-- Trips will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entry Form Section -->
            <div class="form-section" id="form-section">
                <div class="current-trip-info" id="entry-trip-info">
                    Current Trip: None Selected
                </div>
                
                <div class="island-selector">
                    <label for="island">Select Island</label>
                    <select id="island" required>
                        <option value="">Select an island</option>
                        <!-- Islands will be loaded from Firebase -->
                    </select>
                </div>
                
                <!-- Island Total Value Display -->
                <div class="island-total" id="island-total-value" style="margin-top: 15px; display: none;">
                    <h3>Island Total Value: <span id="island-total-amount">RF 0</span></h3>
                </div>
                
                <!-- Quick Customer Registration Button -->
                <div class="quick-customer-btn">
                    <button class="btn btn-success" id="quick-register-btn">
                        <i class="fas fa-user-plus"></i> Quick Customer Registration
                    </button>
                </div>
                
                <!-- Island Customers List -->
                <div class="island-customers" id="island-customers" style="display: none;">
                    <h3>Customers in <span id="selected-island-name"></span> <span class="island-customer-count" id="island-customer-count">0</span></h3>
                    <div id="island-customers-list">
                        <!-- Customers will be listed here -->
                    </div>
                    <div class="island-total" id="island-total">
                        Total Value: RF 0
                    </div>
                </div>
                
                <!-- Customer Registration Form (Initially Hidden) -->
                <div class="customer-registration" id="customer-registration" style="display: none;">
                    <h3>Customer Registration</h3>
                    <form id="customer-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer-name">Customer/Business Name</label>
                                <input type="text" id="customer-name" placeholder="Enter customer name" required>
                            </div>
                            <div class="form-group">
                                <label for="contact">Contact</label>
                                <input type="text" id="contact" placeholder="Enter contact number" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <textarea id="address" placeholder="Enter customer address"></textarea>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-success">Save Customer</button>
                            <button type="button" class="btn btn-warning" id="add-products-btn">Add Products</button>
                        </div>
                    </form>
                </div>
                
                <!-- Product Entry Form (Initially Hidden) -->
                <div class="product-details" id="product-details" style="display: none;">
                    <h3>Product Details</h3>
                    <form id="product-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-date">Date</label>
                                <input type="date" id="product-date" required>
                            </div>
                            <div class="form-group">
                                <label for="product-time">Time</label>
                                <input type="time" id="product-time" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-select">Select Product</label>
                                <select id="product-select" required>
                                    <option value="">Select a product</option>
                                    <!-- Products will be loaded from Firebase -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="product-unit">Unit</label>
                                <select id="product-unit" required>
                                    <option value="kg">Kg</option>
                                    <option value="pcs">Pcs</option>
                                    <option value="foot">Foot</option>
                                    <option value="ltr">Ltr</option>
                                    <option value="case">Case</option>
                                    <option value="dozen">Dozen</option>
                                    <option value="can">Can</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-qty-input">Quantity</label>
                                <input type="number" id="product-qty-input" placeholder="Quantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="boat-fee-input">Boat Fee (RF)</label>
                                <input type="number" id="boat-fee-input" placeholder="Boat Fee Amount" step="0.01" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="payment-method">Payment Method</label>
                                <select id="payment-method" required>
                                    <option value="cash">Cash</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="card">Card</option>
                                    <option value="not-paid">Not Paid</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-desc-input">Description (Optional)</label>
                                <textarea id="product-desc-input" placeholder="Product description"></textarea>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-success">Add Product</button>
                            <button type="button" class="btn btn-primary" id="save-invoice-btn">Save Invoice</button>
                        </div>
                    </form>
                    
                    <div class="product-list-table" id="product-list-table" style="margin-top: 20px; display: none;">
                        <h4>Added Products</h4>
                        <table class="customer-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Product</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    <th>Boat Fee</th>
                                    <th>Subtotal</th>
                                    <th>Description</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="added-products-table">
                                <!-- Added products will be listed here -->
                            </tbody>
                        </table>
                        <div class="total-trips-value" id="order-total">
                            Order Total: RF 0
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- POS System Section -->
            <div class="pos-section" id="pos-section">
                <div class="island-selector">
                    <label for="pos-island">Select Island to View Customers:</label>
                    <select id="pos-island">
                        <option value="all">All Islands</option>
                        <!-- Islands will be loaded from Firebase -->
                    </select>
                </div>
                
                <div class="search-container">
                    <input type="text" id="search-customers" placeholder="Search by customer name or contact...">
                </div>
                
                <div class="customer-list" id="customer-list">
                    <h3>Customers</h3>
                    <table class="customer-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Contact</th>
                                <th>Island</th>
                                <th>Orders</th>
                                <th>Total Value (RF)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                            <!-- Customers will be listed here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Customer Orders Modal -->
                <div id="customer-orders-modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2 id="modal-customer-name">Customer Orders</h2>
                        <div id="customer-orders-list">
                            <!-- Customer orders will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Island Management Section -->
            <div class="island-section" id="island-section">
                <h2>Island Management</h2>
                <p>Add and remove islands for your boat trips</p>
                
                <div class="island-management">
                    <div class="island-form">
                        <input type="text" id="new-island" placeholder="Enter new island name">
                        <button class="btn btn-primary" id="add-island"><i class="fas fa-plus"></i> Add Island</button>
                    </div>
                    
                    <div class="island-list" id="island-list">
                        <h3>Available Islands</h3>
                        <!-- Islands will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Product Management Section -->
            <div class="product-section" id="product-section">
                <h2>Product Management</h2>
                <p>Add and remove products for your boat trips</p>
                
                <div class="product-management">
                    <div class="product-form-with-fee">
                        <input type="text" id="new-product" placeholder="Enter product name">
                        <input type="number" id="new-product-fee" class="product-fee-input" placeholder="Boat Fee (RF)" step="0.01" min="0">
                        <button class="btn btn-primary" id="add-product"><i class="fas fa-plus"></i> Add Product</button>
                    </div>
                    
                    <div class="product-list" id="product-list">
                        <h3>Available Products</h3>
                        <!-- Products will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Payment Management Section -->
            <div class="payment-section" id="payment-section">
                <h2>Payment Management</h2>
                <p>View and manage payments for your boat trips</p>
                
                <!-- Enhanced PDF Export Options -->
                <div class="pdf-export-options">
                    <h3>Export Payment Reports</h3>
                    <div class="export-options-grid">
                        <div class="export-option">
                            <input type="checkbox" id="export-all" checked>
                            <label for="export-all">All Payments</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="export-paid">
                            <label for="export-paid">Paid Only</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="export-unpaid">
                            <label for="export-unpaid">Unpaid Only</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="export-summary" checked>
                            <label for="export-summary">Include Summary</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="export-details" checked>
                            <label for="export-details">Include Details</label>
                        </div>
                    </div>
                    <div class="export-actions">
                        <button class="btn btn-primary" id="export-pdf-btn">
                            <i class="fas fa-file-pdf"></i> Export to PDF
                        </button>
                        <button class="btn btn-success" id="export-csv-btn">
                            <i class="fas fa-file-csv"></i> Export to CSV
                        </button>
                    </div>
                </div>
                
                <div class="payment-filters">
                    <div class="payment-filter active" data-filter="all">All Payments</div>
                    <div class="payment-filter" data-filter="paid">Paid</div>
                    <div class="payment-filter" data-filter="unpaid">Unpaid</div>
                </div>
                
                <div class="payment-list" id="payment-list">
                    <!-- Payment items will be listed here -->
                </div>
                
                <div class="total-trips-value" id="payment-total">
                    Total Value: RF 0
                </div>
            </div>
            
            <!-- User Management Section -->
            <div class="user-section" id="user-section">
                <h2>User Management</h2>
                <p>Manage system users and permissions</p>
                
                <div class="user-management">
                    <div class="user-form">
                        <input type="text" id="new-system-username" placeholder="New username">
                        <input type="password" id="new-system-password" placeholder="New password">
                        <select id="new-system-user-role">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button class="btn btn-primary" id="add-system-user-btn">Add User</button>
                    </div>
                    
                    <div class="access-control">
                        <h3>Access Permissions</h3>
                        <div class="permissions-grid">
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-dashboard" class="system-perm-checkbox" data-perm="dashboard" checked>
                                <label for="system-perm-dashboard">Dashboard</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-trip" class="system-perm-checkbox" data-perm="trip" checked>
                                <label for="system-perm-trip">Trip Management</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-form" class="system-perm-checkbox" data-perm="form" checked>
                                <label for="system-perm-form">Entry Form</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-pos" class="system-perm-checkbox" data-perm="pos" checked>
                                <label for="system-perm-pos">POS System</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-island" class="system-perm-checkbox" data-perm="island" checked>
                                <label for="system-perm-island">Island Management</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-product" class="system-perm-checkbox" data-perm="product" checked>
                                <label for="system-perm-product">Product Management</label>
                            </div>
                            <div class="permission-item">
                                                                <input type="checkbox" id="system-perm-payment" class="system-perm-checkbox" data-perm="payment" checked>
                                <label for="system-perm-payment">Payment Management</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-user" class="system-perm-checkbox" data-perm="user">
                                <label for="system-perm-user">User Management</label>
                            </div>
                            <div class="permission-item">
                                <input type="checkbox" id="system-perm-admin" class="system-perm-checkbox" data-perm="admin">
                                <label for="system-perm-admin">Admin Panel</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-list" id="system-user-list">
                        <h3>System Users</h3>
                        <!-- Users will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Admin Panel Section -->
            <div class="admin-section" id="admin-section">
                <h2>Admin Panel</h2>
                <p>Administrative functions and data management</p>
                
                <div class="admin-panel">
                    <div class="admin-controls">
                        <button class="btn btn-primary" id="backup-data-btn">
                            <i class="fas fa-download"></i> Backup All Data
                        </button>
                        <button class="btn btn-warning" id="restore-data-btn">
                            <i class="fas fa-upload"></i> Restore Data
                        </button>
                        <button class="btn btn-success" id="export-all-invoices-btn">
                            <i class="fas fa-file-pdf"></i> Export All Invoices
                        </button>
                        <button class="btn btn-info" id="view-all-data-btn">
                            <i class="fas fa-database"></i> View All Data
                        </button>
                    </div>
                    
                    <div class="admin-data-view" id="admin-data-view">
                        <p>Select an action to view data here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyipnhQ_PhDyTD490RgshfgSpioXq37eA",
            authDomain: "boatmanagementsystem-5ffba.firebaseapp.com",
            databaseURL: "https://boatmanagementsystem-5ffba-default-rtdb.firebaseio.com",
            projectId: "boatmanagementsystem-5ffba",
            storageBucket: "boatmanagementsystem-5ffba.firebasestorage.app",
            messagingSenderId: "4668108280",
            appId: "1:4668108280:web:b8c0504ccf7a4df2c17a0d",
            measurementId: "G-WZ1LGR0W5Z"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Global variables
        let currentCustomerId = null;
        let currentIsland = null;
        let customerProducts = [];
        let productsChart = null;
        let islandsChart = null;
        let paymentMethodsChart = null;
        let currentOrderId = null;
        let currentTrip = null;
        let currentUser = null;
        let currentUserRole = null;
        let currentUserPermissions = [];

        // Bank details for invoices
        const bankDetails = {
            name: "Niyaamaa Boat Service",
            accountNumberBML: "777 0000 206031",
            accountNumberMIB: "90101400028101002",
            bankNameBML: "Bank of Maldives (BML)",
            bankNameMIB: "Maldives Islamic Bank (MIB)",
            branch: "Male' Branch"
        };

        // Base64 encoded Island Rihaakuru seal image
        const islandSealBase64 = "Island Rihaakuru.png";
        
        // Owner password
        const OWNER_PASSWORD = "NIYAAMA2025";
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('boatSystemUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                currentUser = userData.username;
                currentUserRole = userData.role;
                currentUserPermissions = userData.permissions || [];
                showMainApp();
            } else {
                // Show login screen
                document.getElementById('login-screen').style.display = 'flex';
                
                // Check if owner is trying to access user management
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('admin') === 'true') {
                    document.getElementById('owner-user-management').style.display = 'block';
                }
            }
            
            // Login functionality
            document.getElementById('login-btn').addEventListener('click', function() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (!username || !password) {
                    document.getElementById('login-message').textContent = 'Please enter both username and password';
                    return;
                }
                
                // Check if this is the owner login
                if (password === OWNER_PASSWORD && username === 'owner') {
                    // Owner login
                    currentUser = 'owner';
                    currentUserRole = 'owner';
                    currentUserPermissions = ['dashboard', 'trip', 'form', 'pos', 'island', 'product', 'payment', 'user', 'admin'];
                    localStorage.setItem('boatSystemUser', JSON.stringify({
                        username: 'owner', 
                        role: 'owner',
                        permissions: currentUserPermissions
                    }));
                    showMainApp();
                    return;
                }
                
                // Regular user login
                database.ref('users').orderByChild('username').equalTo(username).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const userData = Object.values(snapshot.val())[0];
                        if (userData.password === password) {
                            currentUser = username;
                            currentUserRole = userData.role;
                            currentUserPermissions = userData.permissions || [];
                            localStorage.setItem('boatSystemUser', JSON.stringify({
                                username, 
                                role: userData.role,
                                permissions: currentUserPermissions
                            }));
                            showMainApp();
                        } else {
                            document.getElementById('login-message').textContent = 'Invalid password';
                        }
                    } else {
                        document.getElementById('login-message').textContent = 'User not found';
                    }
                });
            });
            
            // Add user functionality (owner only)
            document.getElementById('add-user-btn').addEventListener('click', function() {
                const username = document.getElementById('new-username').value;
                const password = document.getElementById('new-password').value;
                const role = document.getElementById('new-user-role').value;
                
                if (!username || !password) {
                    alert('Please enter both username and password');
                    return;
                }
                
                // Get selected permissions
                const permissions = [];
                document.querySelectorAll('.perm-checkbox:checked').forEach(checkbox => {
                    permissions.push(checkbox.dataset.perm);
                });
                
                // Add user to Firebase
                database.ref('users').push({
                    username: username,
                    password: password,
                    role: role,
                    permissions: permissions,
                    created: new Date().toISOString()
                }).then(() => {
                    alert('User added successfully');
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    loadUsers();
                });
            });
            
            // Add system user functionality (from user management tab)
            document.getElementById('add-system-user-btn').addEventListener('click', function() {
                const username = document.getElementById('new-system-username').value;
                const password = document.getElementById('new-system-password').value;
                const role = document.getElementById('new-system-user-role').value;
                
                if (!username || !password) {
                    alert('Please enter both username and password');
                    return;
                }
                
                // Get selected permissions
                const permissions = [];
                document.querySelectorAll('.system-perm-checkbox:checked').forEach(checkbox => {
                    permissions.push(checkbox.dataset.perm);
                });
                
                // Add user to Firebase
                database.ref('users').push({
                    username: username,
                    password: password,
                    role: role,
                    permissions: permissions,
                    created: new Date().toISOString()
                }).then(() => {
                    alert('User added successfully');
                    document.getElementById('new-system-username').value = '';
                    document.getElementById('new-system-password').value = '';
                    loadSystemUsers();
                });
            });
            
           // Full screen functionality
            document.getElementById('fullscreen-btn').addEventListener('click', function() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
                
                document.body.classList.add('fullscreen-mode');
            });
            
            document.getElementById('exit-fullscreen-btn').addEventListener('click', function() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
                
                document.body.classList.remove('fullscreen-mode');
            });
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function() {
                logout();
            });
            
            document.getElementById('header-logout-btn').addEventListener('click', function() {
                logout();
            });
            
            function logout() {
                localStorage.removeItem('boatSystemUser');
                currentUser = null;
                currentUserRole = null;
                currentUserPermissions = [];
                document.getElementById('login-screen').style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
            }
            
            function showMainApp() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('current-user').textContent = currentUser;
                document.getElementById('user-role').textContent = currentUserRole;
                document.getElementById('sidebar-user-name').textContent = currentUser;
                document.getElementById('sidebar-user-role').textContent = currentUserRole;
                
                // Apply user permissions
                applyUserPermissions();
                
                // Show splash screen first
                const splashScreen = document.getElementById('splash-screen');
                const progressBar = document.getElementById('splash-progress');
                const container = document.querySelector('.container');
                
                // Simulate loading progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        // Hide splash screen and show main app
                        splashScreen.style.opacity = '0';
                        setTimeout(() => {
                            splashScreen.style.display = 'none';
                            container.style.opacity = '1';
                            container.style.transform = 'translateY(0)';
                            container.style.display = 'block';
                            
                            // Initialize data after splash screen
                            initializeData();
                        }, 500);
                    }
                }, 100);
            }
            
            function applyUserPermissions() {
                // Show/hide tabs based on permissions
                const tabs = {
                    'dashboard': document.querySelector('[data-tab="dashboard"]'),
                    'trip': document.querySelector('[data-tab="trip"]'),
                    'form': document.querySelector('[data-tab="form"]'),
                    'pos': document.querySelector('[data-tab="pos"]'),
                    'island': document.querySelector('[data-tab="island"]'),
                    'product': document.querySelector('[data-tab="product"]'),
                    'payment': document.querySelector('[data-tab="payment"]'),
                    'user': document.getElementById('user-tab'),
                    'admin': document.getElementById('admin-main-tab')
                };
                
                // Show/hide user management tab based on role
                if (currentUserRole === 'owner' || currentUserRole === 'admin') {
                    document.getElementById('user-management-tab').style.display = 'block';
                    document.getElementById('admin-tab').style.display = 'block';
                } else {
                    document.getElementById('user-management-tab').style.display = 'none';
                    document.getElementById('admin-tab').style.display = 'none';
                }
                
                // Apply permissions to tabs
                Object.keys(tabs).forEach(tab => {
                    if (currentUserPermissions.includes(tab)) {
                        tabs[tab].style.display = 'flex';
                    } else {
                        tabs[tab].style.display = 'none';
                    }
                });
                
                // If current active tab is hidden, switch to dashboard
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.style.display === 'none') {
                    activeTab.classList.remove('active');
                    document.querySelector('[data-tab="dashboard"]').classList.add('active');
                    document.getElementById('dashboard-section').classList.add('active');
                    
                    // Hide all other sections
                    document.querySelectorAll('.content > div').forEach(section => {
                        if (section.id !== 'dashboard-section') {
                            section.classList.remove('active');
                        }
                    });
                }
            }
            
            function loadUsers() {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                
                database.ref('users').once('value').then(snapshot => {
                    const users = snapshot.val();
                    if (!users) return;
                    
                    Object.keys(users).forEach(key => {
                        const user = users[key];
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <div>${user.username} (${user.role})</div>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm edit-user" data-key="${key}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-user" data-key="${key}">Delete</button>
                            </div>
                        `;
                        userList.appendChild(userItem);
                        
                        userItem.querySelector('.delete-user').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete user ${user.username}?`)) {
                                database.ref('users/' + key).remove().then(() => {
                                    loadUsers();
                                });
                            }
                        });
                        
                        userItem.querySelector('.edit-user').addEventListener('click', function() {
                            // Populate form with user data
                            document.getElementById('new-username').value = user.username;
                            document.getElementById('new-password').value = user.password;
                            document.getElementById('new-user-role').value = user.role;
                            
                            // Set permissions
                            document.querySelectorAll('.perm-checkbox').forEach(checkbox => {
                                checkbox.checked = user.permissions && user.permissions.includes(checkbox.dataset.perm);
                            });
                            
                            // Change add button to update button
                            const addBtn = document.getElementById('add-user-btn');
                            addBtn.textContent = 'Update User';
                            addBtn.dataset.mode = 'edit';
                            addBtn.dataset.key = key;
                        });
                    });
                });
            }
            
            function loadSystemUsers() {
                const userList = document.getElementById('system-user-list');
                userList.innerHTML = '';
                
                database.ref('users').once('value').then(snapshot => {
                    const users = snapshot.val();
                    if (!users) {
                        userList.innerHTML = '<p>No users found</p>';
                        return;
                    }
                    
                    Object.keys(users).forEach(key => {
                        const user = users[key];
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <div>${user.username} (${user.role})</div>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm edit-system-user" data-key="${key}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-system-user" data-key="${key}">Delete</button>
                            </div>
                        `;
                        userList.appendChild(userItem);
                        
                        userItem.querySelector('.delete-system-user').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete user ${user.username}?`)) {
                                database.ref('users/' + key).remove().then(() => {
                                    loadSystemUsers();
                                });
                            }
                        });
                        
                        userItem.querySelector('.edit-system-user').addEventListener('click', function() {
                            // Populate form with user data
                            document.getElementById('new-system-username').value = user.username;
                            document.getElementById('new-system-password').value = user.password;
                            document.getElementById('new-system-user-role').value = user.role;
                            
                            // Set permissions
                            document.querySelectorAll('.system-perm-checkbox').forEach(checkbox => {
                                checkbox.checked = user.permissions && user.permissions.includes(checkbox.dataset.perm);
                            });
                            
                            // Change add button to update button
                            const addBtn = document.getElementById('add-system-user-btn');
                            addBtn.textContent = 'Update User';
                            addBtn.dataset.mode = 'edit';
                            addBtn.dataset.key = key;
                        });
                    });
                });
            }
            
            // Mobile sidebar functionality
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            });
            
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            });
            
            // Tab switching functionality
            const tabs = document.querySelectorAll('.tab');
            const dashboardSection = document.getElementById('dashboard-section');
            const tripSection = document.getElementById('trip-section');
            const formSection = document.getElementById('form-section');
            const posSection = document.getElementById('pos-section');
            const islandSection = document.getElementById('island-section');
            const productSection = document.getElementById('product-section');
            const paymentSection = document.getElementById('payment-section');
            const userSection = document.getElementById('user-section');
            const adminSection = document.getElementById('admin-section');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Skip logout button
                    if (this.id === 'logout-btn') return;
                    
                    // Check if user has permission for this tab
                    const tabName = this.dataset.tab;
                    if (!currentUserPermissions.includes(tabName)) {
                        alert('You do not have permission to access this section');
                        return;
                    }
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    dashboardSection.classList.remove('active');
                    tripSection.classList.remove('active');
                    formSection.classList.remove('active');
                    posSection.classList.remove('active');
                    islandSection.classList.remove('active');
                    productSection.classList.remove('active');
                    paymentSection.classList.remove('active');
                    userSection.classList.remove('active');
                    adminSection.classList.remove('active');
                    
                    if (this.dataset.tab === 'dashboard') {
                        dashboardSection.classList.add('active');
                        updateDashboard();
                    } else if (this.dataset.tab === 'trip') {
                        tripSection.classList.add('active');
                        loadTrips();
                    } else if (this.dataset.tab === 'form') {
                        formSection.classList.add('active');
                        loadCustomersForSelection();
                    } else if (this.dataset.tab === 'pos') {
                        posSection.classList.add('active');
                        loadCustomers();
                    } else if (this.dataset.tab === 'island') {
                        islandSection.classList.add('active');
                        loadIslands();
                    } else if (this.dataset.tab === 'product') {
                        productSection.classList.add('active');
                        loadProducts();
                    } else if (this.dataset.tab === 'payment') {
                        paymentSection.classList.add('active');
                        loadPayments('all');
                    } else if (this.dataset.tab === 'user') {
                        userSection.classList.add('active');
                        loadSystemUsers();
                    } else if (this.dataset.tab === 'admin') {
                        adminSection.classList.add('active');
                    }
                    
                    // Close sidebar on mobile after selection
                    sidebar.classList.remove('open');
                    overlay.classList.remove('open');
                });
            });
            
            // Trip creation
            document.getElementById('create-trip-btn').addEventListener('click', function() {
                const tripDate = document.getElementById('trip-date').value;
                const tripNumber = document.getElementById('trip-number').value;
                const tripInvoiceId = document.getElementById('trip-invoice-id').value;
                
                if (!tripDate || !tripNumber) {
                    alert('Please enter trip date and trip number!');
                    return;
                }
                
                const trip = {
                    id: Date.now(),
                    date: tripDate,
                    number: tripNumber,
                    invoiceId: tripInvoiceId,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser
                };
                
                saveTrip(trip);
                setCurrentTrip(trip);
                
                // Clear form
                document.getElementById('trip-date').value = '';
                document.getElementById('trip-number').value = '';
                document.getElementById('trip-invoice-id').value = '';
                
                alert('Trip created successfully!');
            });
            
            // Island selection change in form section
            document.getElementById('island').addEventListener('change', function() {
                currentIsland = this.value;
                if (currentIsland) {
                    document.getElementById('island-customers').style.display = 'block';
                    document.getElementById('selected-island-name').textContent = currentIsland;
                    document.getElementById('island-total-value').style.display = 'block';
                    loadIslandCustomers(currentIsland);
                    calculateIslandTotalValue(currentIsland);
                } else {
                    document.getElementById('island-customers').style.display = 'none';
                    document.getElementById('island-total-value').style.display = 'none';
                }
            });
            
            // Quick customer registration button
            document.getElementById('quick-register-btn').addEventListener('click', function() {
                if (!currentIsland) {
                    alert('Please select an island first!');
                    return;
                }
                
                // Show customer registration form
                document.getElementById('customer-registration').style.display = 'block';
                document.getElementById('island-customers').style.display = 'none';
                document.getElementById('island-total-value').style.display = 'none';
            });
            
            // Date filter functionality
            document.getElementById('apply-filter').addEventListener('click', function() {
                updateDashboard();
            });
            
            document.getElementById('reset-filter').addEventListener('click', function() {
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                document.getElementById('trip-filter').value = 'all';
                updateDashboard();
            });
            
            // Trip filter functionality
            document.getElementById('trip-filter').addEventListener('change', function() {
                updateDashboard();
            });
            
            // Payment filter functionality
            const paymentFilters = document.querySelectorAll('.payment-filter');
            paymentFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    paymentFilters.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    loadPayments(this.dataset.filter);
                });
            });
            
            // Customer form submission
            document.getElementById('customer-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const customerName = document.getElementById('customer-name').value;
                const contact = document.getElementById('contact').value;
                const address = document.getElementById('address').value;
                
                if (!customerName || !contact || !currentIsland) {
                    alert('Please fill all required fields and select an island!');
                    return;
                }
                
                // Create customer object
                const customer = {
                    id: Date.now(),
                    name: customerName,
                    contact: contact,
                    address: address,
                    island: currentIsland,
                    createdBy: currentUser
                };
                
                // Save to Firebase
                saveCustomer(customer);
                
                // Set as current customer
                currentCustomerId = customer.id;
                
                // Show product entry form
                document.getElementById('product-details').style.display = 'block';
                document.getElementById('customer-registration').style.display = 'none';
                
                alert('Customer registered successfully! You can now add products.');
            });
            
            // Add products button
            document.getElementById('add-products-btn').addEventListener('click', function() {
                document.getElementById('product-details').style.display = 'block';
            });
            
            // Product selection change - auto-fill boat fee
            document.getElementById('product-select').addEventListener('change', function() {
                const productId = this.value;
                if (productId) {
                    // Get the boat fee for this product
                    database.ref('productsWithFees/' + productId).once('value').then((snapshot) => {
                        const productData = snapshot.val();
                        if (productData && productData.fee) {
                            document.getElementById('boat-fee-input').value = productData.fee;
                        }
                    });
                }
            });
            
            // Product form submission
            document.getElementById('product-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!currentCustomerId) {
                    alert('Please register or select a customer first!');
                    return;
                }
                
                if (!currentTrip) {
                    alert('Please select a trip first!');
                    return;
                }
                
                const productId = document.getElementById('product-select').value;
                const productName = document.getElementById('product-select').options[document.getElementById('product-select').selectedIndex].text;
                const unit = document.getElementById('product-unit').value;
                const qty = document.getElementById('product-qty-input').value;
                const boatFee = document.getElementById('boat-fee-input').value;
                const description = document.getElementById('product-desc-input').value;
                const date = document.getElementById('product-date').value;
                const time = document.getElementById('product-time').value;
                const paymentMethod = document.getElementById('payment-method').value;
                
                if (!productId || !qty || !boatFee) {
                    alert('Please select a product and enter quantity and boat fee!');
                    return;
                }
                
                const subtotal = (parseFloat(qty) * parseFloat(boatFee)).toFixed(2);
                
                // Add product to the list
                customerProducts.push({
                    productId,
                    productName,
                    unit,
                    qty,
                    boatFeeAmount: boatFee,
                    subtotal,
                    description,
                    date,
                    time,
                    paymentMethod,
                    tripId: currentTrip.id,
                    createdBy: currentUser
                });
                
                // Update the products table
                updateProductsTable();
                
                // Reset form
                document.getElementById('product-select').value = '';
                document.getElementById('product-qty-input').value = '1';
                document.getElementById('boat-fee-input').value = '';
                document.getElementById('product-desc-input').value = '';
                document.getElementById('product-date').valueAsDate = new Date();
                
                alert('Product added to order!');
            });
            
            // Save invoice button
            document.getElementById('save-invoice-btn').addEventListener('click', function() {
                if (customerProducts.length === 0) {
                    alert('Please add at least one product to the order!');
                    return;
                }
                
                if (!currentTrip) {
                    alert('Please select a trip first!');
                    return;
                }
                
                // Calculate total amount
                const totalAmount = customerProducts.reduce((sum, product) => {
                    return sum + parseFloat(product.subtotal);
                }, 0).toFixed(2);
                
                // Create order object
                const order = {
                    id: currentOrderId || Date.now(), // Use existing ID if editing
                    customerId: currentCustomerId,
                    products: customerProducts,
                    date: new Date().toISOString(),
                    paymentStatus: document.getElementById('payment-method').value === 'not-paid' ? 'unpaid' : 'paid',
                    totalAmount: totalAmount,
                    paymentMethod: document.getElementById('payment-method').value,
                    tripId: currentTrip.id,
                    createdBy: currentUser
                };
                
                // Save to Firebase
                saveOrder(order);
                
                // Reset forms
                document.getElementById('customer-form').reset();
                document.getElementById('product-form').reset();
                document.getElementById('customer-registration').style.display = 'none';
                document.getElementById('product-details').style.display = 'none';
                document.getElementById('product-list-table').style.display = 'none';
                document.getElementById('island-customers').style.display = 'block';
                document.getElementById('island-total-value').style.display = 'block';
                
                // Reset variables
                currentCustomerId = null;
                customerProducts = [];
                currentOrderId = null;
                
                // Update island customers list and total value
                loadIslandCustomers(currentIsland);
                calculateIslandTotalValue(currentIsland);
                
                alert('Invoice saved successfully!');
            });
            
            // Add island functionality
            document.getElementById('add-island').addEventListener('click', function() {
                const islandName = document.getElementById('new-island').value.trim();
                if (islandName) {
                    addIsland(islandName);
                    document.getElementById('new-island').value = '';
                } else {
                    alert('Please enter an island name!');
                }
            });
            
            // Add product functionality
            document.getElementById('add-product').addEventListener('click', function() {
                const productName = document.getElementById('new-product').value.trim();
                const productFee = document.getElementById('new-product-fee').value;
                
                if (productName && productFee) {
                    addProduct(productName, productFee);
                    document.getElementById('new-product').value = '';
                    document.getElementById('new-product-fee').value = '';
                } else {
                    alert('Please enter a product name and boat fee!');
                }
            });
            
            // POS Island filter
            document.getElementById('pos-island').addEventListener('change', loadCustomers);
            
            // Search functionality
            document.getElementById('search-customers').addEventListener('input', function() {
                loadCustomers(this.value);
            });
            
            // Modal close functionality
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('customer-orders-modal').style.display = 'none';
            });
            
            // PDF Export functionality
            document.getElementById('export-pdf-btn').addEventListener('click', function() {
                exportPaymentsToPDF();
            });
            
            // CSV Export functionality
            document.getElementById('export-csv-btn').addEventListener('click', function() {
                exportPaymentsToCSV();
            });
            
            // Admin panel functionality
            document.getElementById('backup-data-btn').addEventListener('click', function() {
                backupAllData();
            });
            
            document.getElementById('export-all-invoices-btn').addEventListener('click', function() {
                exportAllInvoices();
            });
            
            document.getElementById('view-all-data-btn').addEventListener('click', function() {
                viewAllData();
            });
            
            // Initialize with today's date
            document.getElementById('product-date').valueAsDate = new Date();
            document.getElementById('trip-date').valueAsDate = new Date();
            
            // Data functions
            function initializeData() {
                // Load islands, products, and boat fees from Firebase
                loadIslandsFromFirebase();
                loadProductsFromFirebase();
                loadTripsFromFirebase();
                
                // Set up real-time listeners
                database.ref('customers').on('value', () => {
                    loadCustomers();
                    loadCustomersForSelection();
                });
                database.ref('orders').on('value', () => {
                    loadCustomers();
                    updateDashboard();
                });
                database.ref('trips').on('value', () => {
                    loadTrips();
                    updateTripFilter();
                });
            }
            
            function setCurrentTrip(trip) {
                currentTrip = trip;
                document.getElementById('current-trip-info').textContent = `Current Trip: ${trip.number} (${trip.date})`;
                document.getElementById('entry-trip-info').textContent = `Current Trip: ${trip.number} (${trip.date})`;
            }
            
            function calculateIslandTotalValue(islandName) {
                getOrders((orders) => {
                    // Filter orders by current trip if selected
                    let filteredOrders = orders;
                    if (currentTrip) {
                        filteredOrders = orders.filter(order => order.tripId == currentTrip.id);
                    }
                    
                    // Get customers from this island
                    getCustomers((customers) => {
                        const islandCustomers = customers.filter(customer => customer.island === islandName);
                        let totalValue = 0;
                        
                        islandCustomers.forEach(customer => {
                            const customerOrders = filteredOrders.filter(order => order.customerId == customer.id);
                            const customerTotal = customerOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            totalValue += customerTotal;
                        });
                        
                        document.getElementById('island-total-amount').textContent = `RF ${totalValue.toFixed(2)}`;
                    });
                });
            }
            
            function loadIslandCustomers(islandName) {
                const islandCustomersList = document.getElementById('island-customers-list');
                islandCustomersList.innerHTML = '';
                
                let totalValue = 0;
                
                // Get customers from this island
                getCustomers((customers) => {
                    const islandCustomers = customers.filter(customer => customer.island === islandName);
                    
                    // Update customer count
                    document.getElementById('island-customer-count').textContent = islandCustomers.length;
                    
                    if (islandCustomers.length === 0) {
                        islandCustomersList.innerHTML = '<p>No customers found for this island.</p>';
                        document.getElementById('island-total').textContent = 'Total Value: RF 0';
                        return;
                    }
                    
                    // Get orders to calculate total value
                    getOrders((orders) => {
                        // Filter orders by current trip if selected
                        let filteredOrders = orders;
                        if (currentTrip) {
                            filteredOrders = orders.filter(order => order.tripId == currentTrip.id);
                        }
                        
                        islandCustomers.forEach(customer => {
                            const customerOrders = filteredOrders.filter(order => order.customerId == customer.id);
                            const customerTotal = customerOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            totalValue += customerTotal;
                            
                            const customerItem = document.createElement('div');
                            customerItem.className = 'island-customer-item';
                            customerItem.dataset.customerId = customer.id;
                            customerItem.innerHTML = `
                                <div>${customer.name} (${customer.contact})</div>
                                <div>RF ${customerTotal.toFixed(2)}</div>
                            `;
                            
                            // Add click event to select customer
                            customerItem.addEventListener('click', function() {
                                selectCustomerForEntry(customer.id);
                            });
                            
                            islandCustomersList.appendChild(customerItem);
                        });
                        
                        document.getElementById('island-total').textContent = `Total Value: RF ${totalValue.toFixed(2)}`;
                    });
                });
            }
            
            function selectCustomerForEntry(customerId) {
                currentCustomerId = customerId;
                
                // Load customer details
                database.ref('customers/' + customerId).once('value').then((snapshot) => {
                    const customer = snapshot.val();
                    if (customer) {
                        // Show product entry form
                        document.getElementById('product-details').style.display = 'block';
                        document.getElementById('customer-registration').style.display = 'none';
                        document.getElementById('island-total-value').style.display = 'none';
                        
                        // Load customer orders to continue adding products
                        getCustomerOrders(customerId, (orders) => {
                            // Filter orders by current trip if selected
                            let filteredOrders = orders;
                            if (currentTrip) {
                                filteredOrders = orders.filter(order => order.tripId == currentTrip.id);
                            }
                            
                            if (filteredOrders.length > 0) {
                                // Use the latest order
                                const latestOrder = filteredOrders[filteredOrders.length - 1];
                                currentOrderId = latestOrder.id;
                                
                                // Load products if any
                                customerProducts = latestOrder.products || [];
                                updateProductsTable();
                            }
                        });
                    }
                });
            }
            
            function loadIslandsFromFirebase() {
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val();
                    if (!islands) {
                        // Add default islands if none exist
                        const defaultIslands = ['K.Male', 'Dhiggaru', 'Mulah', 'Fuvahmulah'];
                        database.ref('islands').set(defaultIslands).then(() => {
                            updateIslandSelects(defaultIslands);
                        });
                    } else {
                        updateIslandSelects(islands);
                    }
                });
            }
            
            function loadProductsFromFirebase() {
                database.ref('productsWithFees').once('value').then((snapshot) => {
                    const products = snapshot.val();
                    if (!products) {
                        // Add default products with fees if none exist
                        const defaultProducts = {
                            'Cement': { name: 'Cement', fee: 5.00 },
                            'Plywood': { name: 'Plywood', fee: 10.00 },
                            'Box -Large': { name: 'Box -Large', fee: 15.00 },
                            'Box-Small': { name: 'Box-Small', fee: 8.00 },
                            'Box- Medium': { name: 'Box- Medium', fee: 12.00 }
                        };
                        
                        database.ref('productsWithFees').set(defaultProducts).then(() => {
                            updateProductSelect(defaultProducts);
                        });
                    } else {
                        updateProductSelect(products);
                    }
                });
            }
            
            function loadTripsFromFirebase() {
                database.ref('trips').once('value').then((snapshot) => {
                    const trips = snapshot.val();
                    if (trips && Object.keys(trips).length > 0) {
                        // Get the most recent trip
                        const tripIds = Object.keys(trips);
                        const mostRecentTripId = tripIds[tripIds.length - 1];
                        setCurrentTrip(trips[mostRecentTripId]);
                    }
                });
            }
            
            function updateIslandSelects(islands) {
                const islandSelect = document.getElementById('island');
                const posIslandSelect = document.getElementById('pos-island');
                
                // Clear existing options except the first one
                while (islandSelect.options.length > 1) {
                    islandSelect.remove(1);
                }
                
                while (posIslandSelect.options.length > 1) {
                    posIslandSelect.remove(1);
                }
                
                // Add islands to selects
                islands.forEach(island => {
                    const option = document.createElement('option');
                    option.value = island;
                    option.textContent = island;
                    islandSelect.appendChild(option);
                    
                    const posOption = document.createElement('option');
                    posOption.value = island;
                    posOption.textContent = island;
                    posIslandSelect.appendChild(posOption);
                });
            }
            
            function updateTripFilter() {
                const tripFilter = document.getElementById('trip-filter');
                
                // Clear existing options except the first one
                while (tripFilter.options.length > 1) {
                    tripFilter.remove(1);
                }
                
                // Get trips from Firebase
                database.ref('trips').once('value').then((snapshot) => {
                    const trips = snapshot.val();
                    if (!trips) return;
                    
                    // Add trips to filter
                    Object.values(trips).forEach(trip => {
                        const option = document.createElement('option');
                        option.value = trip.id;
                        option.textContent = `${trip.number} (${trip.date})`;
                        tripFilter.appendChild(option);
                    });
                });
            }
            
            function updateProductSelect(products) {
                const productSelect = document.getElementById('product-select');
                
                // Clear existing options except the first one
                while (productSelect.options.length > 1) {
                    productSelect.remove(1);
                }
                
                // Add products to select
                Object.keys(products).forEach(productId => {
                    const product = products[productId];
                    const option = document.createElement('option');
                    option.value = productId;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
            }
            
            function loadIslands() {
                const islandList = document.getElementById('island-list');
                
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val();
                    
                    // Clear current list
                    islandList.innerHTML = '<h3>Available Islands</h3>';
                    
                    if (!islands || islands.length === 0) {
                        islandList.innerHTML += '<p>No islands added yet.</p>';
                        return;
                    }
                    
                    // Create island items
                    islands.forEach(island => {
                        const islandItem = document.createElement('div');
                        islandItem.className = 'island-item';
                        islandItem.innerHTML = `
                            <div class="island-name">${island}</div>
                            <button class="btn btn-danger btn-sm delete-island" data-island="${island}"><i class="fas fa-trash"></i> Delete</button>
                        `;
                        
                        islandList.appendChild(islandItem);
                        
                        // Add event listener to delete button
                        islandItem.querySelector('.delete-island').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete ${island}?`)) {
                                deleteIsland(island);
                            }
                        });
                    });
                });
            }
            
            function loadTrips() {
                const tripList = document.getElementById('trip-list');
                
                database.ref('trips').once('value').then((snapshot) => {
                    const trips = snapshot.val();
                    
                    // Clear current list
                    tripList.innerHTML = '';
                    
                    if (!trips || Object.keys(trips).length === 0) {
                        tripList.innerHTML = '<p>No trips created yet.</p>';
                        return;
                    }
                    
                    // Create trip items
                    Object.values(trips).forEach(trip => {
                        const tripItem = document.createElement('div');
                        tripItem.className = 'trip-item';
                        tripItem.innerHTML = `
                            <div class="trip-info">
                                <div><strong>${trip.number}</strong> - ${trip.date}</div>
                                <div>Invoice ID: ${trip.invoiceId || 'N/A'}</div>
                            </div>
                            <div class="trip-actions">
                                <button class="btn btn-primary btn-sm select-trip" data-id="${trip.id}">Select</button>
                                <button class="btn btn-danger btn-sm delete-trip" data-id="${trip.id}">Delete</button>
                            </div>
                        `;
                        
                        tripList.appendChild(tripItem);
                        
                        // Add event listener to select button
                        tripItem.querySelector('.select-trip').addEventListener('click', function() {
                            setCurrentTrip(trip);
                            alert(`Trip ${trip.number} selected!`);
                        });
                        
                        // Add event listener to delete button
                        tripItem.querySelector('.delete-trip').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete trip ${trip.number}?`)) {
                                deleteTrip(trip.id);
                            }
                        });
                    });
                });
            }
            
            function loadProducts() {
                const productList = document.getElementById('product-list');
                
                database.ref('productsWithFees').once('value').then((snapshot) => {
                    const products = snapshot.val();
                    
                    // Clear current list
                    productList.innerHTML = '<h3>Available Products</h3>';
                    
                    if (!products || Object.keys(products).length === 0) {
                        productList.innerHTML += '<p>No products added yet.</p>';
                        return;
                    }
                    
                    // Create product items
                    Object.keys(products).forEach(productId => {
                        const product = products[productId];
                        const productItem = document.createElement('div');
                        productItem.className = 'product-item-with-fee';
                        productItem.innerHTML = `
                            <div class="product-name">${product.name} <span class="product-fee-display">(RF ${product.fee})</span></div>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm edit-product-fee" data-id="${productId}"><i class="fas fa-edit"></i> Edit</button>
                                <button class="btn btn-danger btn-sm delete-product" data-id="${productId}"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        `;
                        
                        productList.appendChild(productItem);
                        
                        // Add event listener to edit button
                        productItem.querySelector('.edit-product-fee').addEventListener('click', function() {
                            const newFee = prompt(`Enter new boat fee for ${product.name}:`, product.fee);
                            if (newFee !== null && !isNaN(newFee) && newFee >= 0) {
                                updateProductFee(productId, parseFloat(newFee));
                            }
                        });
                        
                        // Add event listener to delete button
                        productItem.querySelector('.delete-product').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete ${product.name}?`)) {
                                deleteProduct(productId);
                            }
                        });
                    });
                });
            }
            
            function saveTrip(trip) {
                database.ref('trips/' + trip.id).set(trip);
            }
            
            function deleteTrip(tripId) {
                database.ref('trips/' + tripId).remove().then(() => {
                    loadTrips();
                    alert('Trip deleted successfully!');
                });
            }
            
            function addIsland(islandName) {
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val() || [];
                    if (!islands.includes(islandName)) {
                        islands.push(islandName);
                        database.ref('islands').set(islands).then(() => {
                            updateIslandSelects(islands);
                            loadIslands();
                            alert('Island added successfully!');
                        });
                    } else {
                        alert('This island already exists!');
                    }
                });
            }
            
            function deleteIsland(islandName) {
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val();
                    const updatedIslands = islands.filter(island => island !== islandName);
                    database.ref('islands').set(updatedIslands).then(() => {
                        updateIslandSelects(updatedIslands);
                        loadIslands();
                        alert('Island deleted successfully!');
                    });
                });
            }
            
            function addProduct(productName, productFee) {
                database.ref('productsWithFees').once('value').then((snapshot) => {
                    const products = snapshot.val() || {};
                    
                    // Check if product already exists
                    let productExists = false;
                    Object.keys(products).forEach(id => {
                        if (products[id].name.toLowerCase() === productName.toLowerCase()) {
                            productExists = true;
                        }
                    });
                    
                    if (!productExists) {
                        const productId = Date.now().toString();
                        products[productId] = {
                            name: productName,
                            fee: parseFloat(productFee)
                        };
                        
                        database.ref('productsWithFees').set(products).then(() => {
                            updateProductSelect(products);
                            loadProducts();
                            alert('Product added successfully!');
                        });
                    } else {
                        alert('This product already exists!');
                    }
                });
            }
            
            function updateProductFee(productId, newFee) {
                database.ref('productsWithFees/' + productId + '/fee').set(newFee).then(() => {
                    loadProducts();
                    alert('Product fee updated successfully!');
                });
            }
            
            function deleteProduct(productId) {
                database.ref('productsWithFees/' + productId).remove().then(() => {
                    loadProducts();
                    alert('Product deleted successfully!');
                });
            }
            
            function saveCustomer(customer) {
                database.ref('customers/' + customer.id).set(customer);
            }
            
            function saveOrder(order) {
                database.ref('orders/' + order.id).set(order);
            }
            
            function getCustomers(callback) {
                database.ref('customers').once('value').then((snapshot) => {
                    const customers = snapshot.val();
                    const customersArray = customers ? Object.values(customers) : [];
                    callback(customersArray);
                });
            }
            
            function getOrders(callback) {
                database.ref('orders').once('value').then((snapshot) => {
                    const orders = snapshot.val();
                    const ordersArray = orders ? Object.values(orders) : [];
                    callback(ordersArray);
                });
            }
            
            function getCustomerOrders(customerId, callback) {
                database.ref('orders').once('value').then((snapshot) => {
                    const orders = snapshot.val();
                    const ordersArray = orders ? Object.values(orders) : [];
                    const customerOrders = ordersArray.filter(order => order.customerId == customerId);
                    callback(customerOrders);
                });
            }
            
            function updateProductsTable() {
                const tableBody = document.getElementById('added-products-table');
                tableBody.innerHTML = '';
                
                let orderTotal = 0;
                
                customerProducts.forEach((product, index) => {
                    orderTotal += parseFloat(product.subtotal);
                    
                    const row = document.createElement('tr');
                    
                    // Apply styling based on payment method
                    if (product.paymentMethod === 'not-paid') {
                        row.classList.add('unpaid-row');
                    } else {
                        row.classList.add('paid-row');
                    }
                    
                    // Add payment method class for styling
                    const paymentMethodClass = `payment-method-${product.paymentMethod}`;
                    
                    row.innerHTML = `
                        <td>${product.date} ${product.time}</td>
                        <td>${product.productName}</td>
                        <td>${product.qty}</td>
                        <td>${product.unit}</td>
                        <td>RF ${product.boatFeeAmount}</td>
                        <td>RF ${product.subtotal}</td>
                        <td>${product.description || '-'}</td>
                        <td class="payment-method-cell ${paymentMethodClass}">${product.paymentMethod}</td>
                        <td class="action-buttons">
                            <button class="btn btn-warning btn-xs edit-product" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-xs remove-product" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    
                    
                    // Add event listener to edit button
                    row.querySelector('.edit-product').addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const product = customerProducts[index];
                        
                        // Fill the form with product data
                        document.getElementById('product-select').value = product.productId;
                        document.getElementById('product-unit').value = product.unit;
                        document.getElementById('product-qty-input').value = product.qty;
                        document.getElementById('boat-fee-input').value = product.boatFeeAmount;
                        document.getElementById('product-desc-input').value = product.description || '';
                        document.getElementById('payment-method').value = product.paymentMethod;
                        document.getElementById('product-date').value = product.date;
                        document.getElementById('product-time').value = product.time;
                        
                        // Remove the product from the list
                        customerProducts.splice(index, 1);
                        updateProductsTable();
                    });
                });
                
                document.getElementById('order-total').textContent = `Order Total: RF ${orderTotal.toFixed(2)}`;
                document.getElementById('product-list-table').style.display = 'block';
            }
            
            function loadCustomers(searchTerm = '') {
                const customerTableBody = document.getElementById('customer-table-body');
                const islandFilter = document.getElementById('pos-island').value;
                
                // Clear current table
                customerTableBody.innerHTML = '';
                
                // Get customers and orders from Firebase
                getCustomers((customers) => {
                    getOrders((orders) => {
                        // Filter by island if needed
                        let filteredCustomers = islandFilter === 'all' 
                            ? customers 
                            : customers.filter(customer => customer.island === islandFilter);
                        
                        // Filter by search term if provided
                        if (searchTerm) {
                            const term = searchTerm.toLowerCase();
                            filteredCustomers = filteredCustomers.filter(customer => 
                                customer.name.toLowerCase().includes(term) ||
                                customer.contact.toLowerCase().includes(term)
                            );
                        }
                        
                        if (filteredCustomers.length === 0) {
                            customerTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No customers found.</td></tr>';
                            return;
                        }
                        
                         // Create customer rows
                        filteredCustomers.forEach(customer => {
                            // Count orders for this customer
                            const customerOrders = orders.filter(order => order.customerId == customer.id);
                            const customerTotal = customerOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${customer.name}</td>
                                <td>${customer.contact}</td>
                                <td>${customer.island}</td>
                                <td>${customerOrders.length}</td>
                                <td>RF ${customerTotal.toFixed(2)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-primary btn-sm view-orders" data-id="${customer.id}" data-name="${customer.name}">
                                        <i class="fas fa-eye"></i> View Orders
                                    </button>
                                    <button class="btn btn-warning btn-sm edit-customer" data-id="${customer.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-customer" data-id="${customer.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            customerTableBody.appendChild(row);
                            
                            // Add event listener to view orders button
                            row.querySelector('.view-orders').addEventListener('click', function() {
                                const customerId = this.dataset.id;
                                const customerName = this.dataset.name;
                                showCustomerOrders(customerId, customerName);
                            });
                            
                            // Add event listener to edit customer button
                            row.querySelector('.edit-customer').addEventListener('click', function() {
                                const customerId = this.dataset.id;
                                editCustomer(customerId);
                            });
                            
                            // Add event listener to delete customer button
                            row.querySelector('.delete-customer').addEventListener('click', function() {
                                const customerId = this.dataset.id;
                                if (confirm('Are you sure you want to delete this customer?')) {
                                    deleteCustomer(customerId);
                                }
                            });
                        });
                    });
                });
            }
            
            function editCustomer(customerId) {
                database.ref('customers/' + customerId).once('value').then((snapshot) => {
                    const customer = snapshot.val();
                    if (customer) {
                        // Switch to form tab
                        document.querySelector('[data-tab="form"]').click();
                        
                        // Set island
                        document.getElementById('island').value = customer.island;
                        currentIsland = customer.island;
                        
                        // Show island customers
                        document.getElementById('island-customers').style.display = 'block';
                        document.getElementById('selected-island-name').textContent = customer.island;
                        loadIslandCustomers(customer.island);
                        
                        // Select the customer
                        selectCustomerForEntry(customerId);
                    }
                });
            }
            
            function deleteCustomer(customerId) {
                // First check if customer has orders
                getCustomerOrders(customerId, (orders) => {
                    if (orders.length > 0) {
                        alert('Cannot delete customer with existing orders. Please delete orders first.');
                        return;
                    }
                    
                    // Delete customer
                    database.ref('customers/' + customerId).remove().then(() => {
                        alert('Customer deleted successfully!');
                        loadCustomers();
                    });
                });
            }
            
            function showCustomerOrders(customerId, customerName) {
                const modal = document.getElementById('customer-orders-modal');
                const customerOrdersList = document.getElementById('customer-orders-list');
                const modalCustomerName = document.getElementById('modal-customer-name');
                
                modalCustomerName.textContent = `Orders for ${customerName}`;
                customerOrdersList.innerHTML = '<p>Loading orders...</p>';
                
                modal.style.display = 'block';
                
                getCustomerOrders(customerId, (orders) => {
                    if (orders.length === 0) {
                        customerOrdersList.innerHTML = '<p>No orders found for this customer.</p>';
                        return;
                    }
                    
                    customerOrdersList.innerHTML = '';
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.date).toLocaleDateString();
                        
                        const orderCard = document.createElement('div');
                        orderCard.className = 'trip-card';
                        orderCard.innerHTML = `
                            <div class="trip-header">
                                <div class="trip-date">${orderDate}</div>
                                <div class="trip-status ${order.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                    ${order.paymentStatus.toUpperCase()}
                                </div>
                            </div>
                            <div class="trip-products">
                                <strong>Total Amount:</strong> RF ${order.totalAmount}<br>
                                <strong>Payment Method:</strong> ${order.paymentMethod}<br>
                                <strong>Trip:</strong> ${order.tripId ? getTripName(order.tripId) : 'N/A'}<br>
                                <strong>Products:</strong>
                                <ul>
                                    ${order.products.map(product => `
                                        <li>${product.date} ${product.time} - ${product.productName} - ${product.qty} ${product.unit} @ RF ${product.boatFeeAmount} = RF ${product.subtotal}</li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="trip-actions">
                                <button class="btn btn-primary btn-sm generate-invoice" data-id="${order.id}">
                                    <i class="fas fa-file-pdf"></i> Generate Invoice
                                </button>
                                ${order.paymentStatus === 'unpaid' ? 
                                    `<button class="btn btn-success btn-sm mark-paid" data-id="${order.id}">
                                        <i class="fas fa-check"></i> Mark as Paid
                                    </button>` : 
                                    `<button class="btn btn-warning btn-sm mark-unpaid" data-id="${order.id}">
                                        <i class="fas fa-times"></i> Mark as Unpaid
                                    </button>`
                                }
                                <button class="btn btn-warning btn-sm add-more-products" data-id="${order.id}" data-customer="${customerId}">
                                    <i class="fas fa-plus"></i> Add More Products
                                </button>
                                <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">
                                    <i class="fas fa-trash"></i> Delete Order
                                </button>
                            </div>
                        `;
                        
                        customerOrdersList.appendChild(orderCard);
                        
                        // Add event listeners
                        orderCard.querySelector('.generate-invoice').addEventListener('click', function() {
                            generateOrderInvoice(order);
                        });
                        
                        if (order.paymentStatus === 'unpaid') {
                            orderCard.querySelector('.mark-paid').addEventListener('click', function() {
                                updateOrderPaymentStatus(order.id, 'paid');
                                alert('Order marked as paid!');
                                showCustomerOrders(customerId, customerName);
                            });
                        } else {
                            orderCard.querySelector('.mark-unpaid').addEventListener('click', function() {
                                updateOrderPaymentStatus(order.id, 'unpaid');
                                alert('Order marked as unpaid!');
                                showCustomerOrders(customerId, customerName);
                            });
                        }
                        
                        // Add more products to existing order
                        orderCard.querySelector('.add-more-products').addEventListener('click', function() {
                            const orderId = this.dataset.id;
                            const customerId = this.dataset.customer;
                            
                            // Switch to form tab
                            document.querySelector('[data-tab="form"]').click();
                            
                            // Load customer data
                            database.ref('customers/' + customerId).once('value').then((snapshot) => {
                                const customer = snapshot.val();
                                if (customer) {
                                    // Set island
                                    document.getElementById('island').value = customer.island;
                                    currentIsland = customer.island;
                                    
                                    // Show island customers
                                    document.getElementById('island-customers').style.display = 'block';
                                    document.getElementById('selected-island-name').textContent = customer.island;
                                    loadIslandCustomers(customer.island);
                                    
                                    // Select the customer
                                    selectCustomerForEntry(customerId);
                                    
                                    // Load order data
                                    database.ref('orders/' + orderId).once('value').then((snapshot) => {
                                        const order = snapshot.val();
                                        if (order) {
                                            // Set products
                                            customerProducts = order.products;
                                            updateProductsTable();
                                            
                                            alert('You can now add more products to this order.');
                                        }
                                    });
                                }
                            });
                        });
                        
                        // Delete order
                        orderCard.querySelector('.delete-order').addEventListener('click', function() {
                            const orderId = this.dataset.id;
                            if (confirm('Are you sure you want to delete this order?')) {
                                database.ref('orders/' + orderId).remove().then(() => {
                                    alert('Order deleted successfully!');
                                    showCustomerOrders(customerId, customerName);
                                });
                            }
                        });
                    });
                });
            }
            
            function getTripName(tripId) {
                // This would be replaced with actual trip data lookup
                return `Trip ${tripId}`;
            }
            
            function updateOrderPaymentStatus(orderId, status) {
                database.ref('orders/' + orderId + '/paymentStatus').set(status);
            }
            
            function generateOrderInvoice(order) {
                // Get customer details
                database.ref('customers/' + order.customerId).once('value').then((snapshot) => {
                    const customer = snapshot.val();
                    
                    // Get trip details if available
                    let tripInfo = {};
                    if (order.tripId) {
                        database.ref('trips/' + order.tripId).once('value').then((tripSnapshot) => {
                            tripInfo = tripSnapshot.val() || {};
                            
                            createInvoiceDocument(order, customer, tripInfo);
                        });
                    } else {
                        createInvoiceDocument(order, customer, {});
                    }
                });
            }
            
            function createInvoiceDocument(order, customer, tripInfo) {
                const doc = new jsPDF();
                
                // Add logo and header
                doc.setFontSize(20);
                doc.setTextColor(26, 42, 108);
                doc.text('NIYAAMAA BOAT', 105, 20, { align: 'center' });
                doc.setFontSize(16);
                doc.text('INVOICE', 105, 30, { align: 'center' });
                
                // Add invoice details - Left side (Customer Info)
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Customer: ${customer.name}`, 16, 45);
                doc.text(`Contact: ${customer.contact}`, 16, 52);
                doc.text(`Island: ${customer.island}`, 16, 59);
                
                // Add invoice details - Right side (Invoice Info)
                doc.text(`Invoice ID: ${tripInfo.invoiceId || `BT${order.id}`}`, 195, 45, { align: 'right' });
                doc.text(`Date: ${new Date(order.date).toLocaleDateString()}`, 195, 52, { align: 'right' });
                doc.text(`Trip: ${tripInfo.number || 'N/A'}`, 195, 59, { align: 'right' });
                
                // Add status and payment method
                doc.text(`Status: ${order.paymentStatus.toUpperCase()}`, 16, 66);
                doc.text(`Payment Method: ${order.paymentMethod}`, 17, 73);
                
                // Add products table
                const tableColumn = ["Date & Time", "Product", "Qty", "Unit", "Boat Fee", "Payment Method", "Subtotal"];
                const tableRows = [];
                
                order.products.forEach(product => {
                    const productData = [
                        `${product.date} ${product.time}`,
                        product.productName,
                        product.qty,
                        product.unit,
                        `RF ${product.boatFeeAmount}`,
                        product.paymentMethod,
                        `RF ${product.subtotal}`
                    ];
                    tableRows.push(productData);
                });
                
                // Add total row
                tableRows.push([
                    'TOTAL',
                    '',
                    '',
                    '',
                    '',
                    '',
                    `RF ${order.totalAmount}`
                ]);
                
                // Generate the table
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 90,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [26, 42, 108],
                        textColor: [255, 255, 255]
                    },
                    foot: [['TOTAL', '', '', '', '', '', `RF ${order.totalAmount}`]],
                    footStyles: {
                        fillColor: [253, 187, 45],
                        textColor: [0, 0, 0]
                    },
                    didDrawCell: function(data) {
                        // Highlight unpaid products in red
                        if (data.section === 'body' && data.column.index === 5 && data.cell.raw === 'not-paid') {
                            doc.setFillColor(255, 230, 230);
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        }
                    }
                });
                
                 // Add Island Rihaakuru seal to the bottom right
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.addImage(islandSealBase64, 'PNG', 150, finalY, 40, 40);
                
                
                // Add bank details with styling
               
                
                doc.setFontSize(12);
                doc.setTextColor(26, 42, 108);
                doc.text('Bank Details:', 25, finalY + 8);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`${bankDetails.bankNameBML}`, 25, finalY + 16);
                doc.text(`Account: ${bankDetails.accountNumberBML}`, 25, finalY + 22);
                
                doc.text(`${bankDetails.bankNameMIB}`, 25, finalY + 30);
                doc.text(`Account: ${bankDetails.accountNumberMIB}`, 25, finalY + 36);
                
                // Add Thank You message at the bottom center
                doc.setFontSize(12);
                doc.setTextColor(26, 42, 108);
                doc.text('Thank You For Your Business!', 105, finalY + 50, { align: 'center' });
                
                // Save the PDF
                doc.save(`Invoice_${tripInfo.invoiceId || `BT${order.id}`}_${customer.name}.pdf`);
            }
            
            // Load payments for payment management
            function loadPayments(filter) {
                const paymentList = document.getElementById('payment-list');
                const paymentTotal = document.getElementById('payment-total');
                
                // Clear current list
                paymentList.innerHTML = '';
                
                let totalValue = 0;
                
                // Get orders and customers from Firebase
                getOrders((orders) => {
                    getCustomers((customers) => {
                        // Filter orders based on payment status
                        let filteredOrders = orders;
                        if (filter !== 'all') {
                            filteredOrders = orders.filter(order => order.paymentStatus === filter);
                        }
                        
                        if (filteredOrders.length === 0) {
                            paymentList.innerHTML = '<p>No payments found.</p>';
                            paymentTotal.textContent = 'Total Value: RF 0';
                            return;
                        }
                        
                        // Create payment items
                        filteredOrders.forEach(order => {
                            const customer = customers.find(c => c.id == order.customerId);
                            
                            if (!customer) return;
                            
                            totalValue += parseFloat(order.totalAmount || 0);
                            
                            const paymentItem = document.createElement('div');
                            paymentItem.className = 'payment-item';
                            
                                // Format date
                            const orderDate = new Date(order.date).toLocaleDateString();
                            
                            paymentItem.innerHTML = `
                                <div class="payment-info">
                                    <p><strong>${customer.name}</strong> - ${customer.island} (${orderDate})</p>
                                    <p>${order.products.length} products</p>
                                    <p>Payment Method: ${order.paymentMethod}</p>
                                    <p>Trip: ${order.tripId ? getTripName(order.tripId) : 'N/A'}</p>
                                </div>
                                <div class="payment-amount">
                                    RF ${order.totalAmount}
                                </div>
                                <div class="payment-actions">
                                                                   <span class="trip-status ${order.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                        ${order.paymentStatus.toUpperCase()}
                                    </span>
                                    <button class="btn btn-primary btn-sm view-payment" data-id="${order.id}">View</button>
                                </div>
                            `;
                            paymentList.appendChild(paymentItem);
                            
                            // Add event listener to view button
                            paymentItem.querySelector('.view-payment').addEventListener('click', function() {
                                // Switch to POS tab and show the customer orders
                                document.querySelector('[data-tab="pos"]').click();
                                showCustomerOrders(order.customerId, customer.name);
                            });
                        });
                        
                        paymentTotal.textContent = `Total Value: RF ${totalValue.toFixed(2)}`;
                    });
                });
            }
            
            // Export payments to PDF
            function exportPaymentsToPDF() {
                const exportAll = document.getElementById('export-all').checked;
                const exportPaid = document.getElementById('export-paid').checked;
                const exportUnpaid = document.getElementById('export-unpaid').checked;
                const exportSummary = document.getElementById('export-summary').checked;
                const exportDetails = document.getElementById('export-details').checked;
                
                // Determine filter based on selection
                let filter = 'all';
                if (!exportAll) {
                    if (exportPaid && !exportUnpaid) filter = 'paid';
                    if (!exportPaid && exportUnpaid) filter = 'unpaid';
                    if (exportPaid && exportUnpaid) filter = 'all';
                }
                
                getOrders((orders) => {
                    getCustomers((customers) => {
                        // Filter orders based on selection
                        let filteredOrders = orders;
                        if (filter !== 'all') {
                            filteredOrders = orders.filter(order => order.paymentStatus === filter);
                        }
                        
                        if (filteredOrders.length === 0) {
                            alert('No payments found for the selected criteria.');
                            return;
                        }
                        
                        const doc = new jsPDF();
                        
                        // Add header
                        doc.setFontSize(20);
                        doc.setTextColor(26, 42, 108);
                        doc.text('NIYAAMAA BOAT', 105, 20, { align: 'center' });
                        doc.setFontSize(16);
                        doc.text('PAYMENT REPORT', 105, 30, { align: 'center' });
                        
                        // Add date range if available
                        const startDate = document.getElementById('start-date').value;
                        const endDate = document.getElementById('end-date').value;
                        
                        if (startDate && endDate) {
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            doc.text(`Date Range: ${startDate} to ${endDate}`, 105, 40, { align: 'center' });
                        }
                        
                        let yPosition = 50;
                        
                        // Add summary if selected
                        if (exportSummary) {
                            doc.setFontSize(14);
                            doc.setTextColor(26, 42, 108);
                            doc.text('SUMMARY', 20, yPosition);
                            yPosition += 10;
                            
                            // Calculate totals
                            const totalAmount = filteredOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            const paidOrders = filteredOrders.filter(order => order.paymentStatus === 'paid');
                            const unpaidOrders = filteredOrders.filter(order => order.paymentStatus === 'unpaid');
                            const paidAmount = paidOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            const unpaidAmount = unpaidOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            doc.text(`Total Orders: ${filteredOrders.length}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Paid Orders: ${paidOrders.length}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Unpaid Orders: ${unpaidOrders.length}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Total Amount: RF ${totalAmount.toFixed(2)}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Paid Amount: RF ${paidAmount.toFixed(2)}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Unpaid Amount: RF ${unpaidAmount.toFixed(2)}`, 20, yPosition);
                            yPosition += 15;
                        }
                        
                        // Add details if selected
                        if (exportDetails) {
                            doc.setFontSize(14);
                            doc.setTextColor(26, 42, 108);
                            doc.text('DETAILS', 20, yPosition);
                            yPosition += 10;
                            
                            // Create table
                            const tableColumn = ["Customer", "Island", "Date", "Amount", "Status", "Payment Method"];
                            const tableRows = [];
                            
                            filteredOrders.forEach(order => {
                                const customer = customers.find(c => c.id == order.customerId);
                                const orderDate = new Date(order.date).toLocaleDateString();
                                
                                tableRows.push([
                                    customer ? customer.name : 'Unknown',
                                    customer ? customer.island : 'Unknown',
                                    orderDate,
                                    `RF ${order.totalAmount}`,
                                    order.paymentStatus.toUpperCase(),
                                    order.paymentMethod
                                ]);
                            });
                            
                            // Generate the table
                            doc.autoTable({
                                head: [tableColumn],
                                body: tableRows,
                                startY: yPosition,
                                theme: 'grid',
                                headStyles: {
                                    fillColor: [26, 42, 108],
                                    textColor: [255, 255, 255]
                                }
                            });
                        }
                        
                        // Save the PDF
                        const dateStr = new Date().toISOString().slice(0, 10);
                        doc.save(`Payment_Report_${dateStr}.pdf`);
                    });
                });
            }
            
            // Export payments to CSV
            function exportPaymentsToCSV() {
                const exportAll = document.getElementById('export-all').checked;
                const exportPaid = document.getElementById('export-paid').checked;
                const exportUnpaid = document.getElementById('export-unpaid').checked;
                
                // Determine filter based on selection
                let filter = 'all';
                if (!exportAll) {
                    if (exportPaid && !exportUnpaid) filter = 'paid';
                    if (!exportPaid && exportUnpaid) filter = 'unpaid';
                    if (exportPaid && exportUnpaid) filter = 'all';
                }
                
                getOrders((orders) => {
                    getCustomers((customers) => {
                        // Filter orders based on selection
                        let filteredOrders = orders;
                        if (filter !== 'all') {
                            filteredOrders = orders.filter(order => order.paymentStatus === filter);
                        }
                        
                        if (filteredOrders.length === 0) {
                            alert('No payments found for the selected criteria.');
                            return;
                        }
                        
                        // Create CSV content
                        let csvContent = "Customer,Island,Date,Amount,Status,Payment Method\n";
                        
                        filteredOrders.forEach(order => {
                            const customer = customers.find(c => c.id == order.customerId);
                            const orderDate = new Date(order.date).toLocaleDateString();
                            
                            csvContent += `"${customer ? customer.name : 'Unknown'}","${customer ? customer.island : 'Unknown'}","${orderDate}","RF ${order.totalAmount}","${order.paymentStatus.toUpperCase()}","${order.paymentMethod}"\n`;
                        });
                        
                        // Create download link
                        const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        
                        const dateStr = new Date().toISOString().slice(0, 10);
                        link.setAttribute("download", `Payment_Report_${dateStr}.csv`);
                        document.body.appendChild(link);
                        
                        link.click();
                        document.body.removeChild(link);
                    });
                });
            }
            
            // Admin panel functions
            function backupAllData() {
                // Get all data from Firebase
                Promise.all([
                    database.ref('customers').once('value'),
                    database.ref('orders').once('value'),
                    database.ref('trips').once('value'),
                    database.ref('productsWithFees').once('value'),
                    database.ref('islands').once('value'),
                    database.ref('users').once('value')
                ]).then(([customers, orders, trips, products, islands, users]) => {
                    const allData = {
                        customers: customers.val(),
                        orders: orders.val(),
                        trips: trips.val(),
                        products: products.val(),
                        islands: islands.val(),
                        users: users.val(),
                        backupDate: new Date().toISOString()
                    };
                    
                    // Create a JSON file for download
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "boat_system_backup_" + new Date().toISOString().slice(0, 10) + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    
                    alert('Backup completed successfully!');
                });
            }
            
            function exportAllInvoices() {
                getOrders((orders) => {
                    getCustomers((customers) => {
                        if (orders.length === 0) {
                            alert('No invoices found to export.');
                            return;
                        }
                        
                        const doc = new jsPDF();
                        let currentPage = 1;
                        let yPosition = 20;
                        
                        orders.forEach((order, index) => {
                            if (index > 0) {
                                doc.addPage();
                                currentPage++;
                                yPosition = 20;
                            }
                            
                            const customer = customers.find(c => c.id == order.customerId);
                            const orderDate = new Date(order.date).toLocaleDateString();
                            
                            // Add invoice header
                            doc.setFontSize(16);
                            doc.setTextColor(26, 42, 108);
                            doc.text('INVOICE', 105, yPosition, { align: 'center' });
                            yPosition += 10;
                            
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0);
                            doc.text(`Customer: ${customer ? customer.name : 'Unknown'}`, 20, yPosition);
                            doc.text(`Date: ${orderDate}`, 180, yPosition, { align: 'right' });
                            yPosition += 10;
                            
                            doc.text(`Island: ${customer ? customer.island : 'Unknown'}`, 20, yPosition);
                            doc.text(`Invoice ID: ${order.id}`, 180, yPosition, { align: 'right' });
                            yPosition += 10;
                            
                            // Add products table
                            const tableColumn = ["Product", "Qty", "Unit", "Boat Fee", "Subtotal"];
                            const tableRows = [];
                            
                            order.products.forEach(product => {
                                tableRows.push([
                                    product.productName,
                                    product.qty,
                                    product.unit,
                                    `RF ${product.boatFeeAmount}`,
                                    `RF ${product.subtotal}`
                                ]);
                            });
                            
                            // Add total row
                            tableRows.push([
                                'TOTAL',
                                '',
                                '',
                                '',
                                `RF ${order.totalAmount}`
                            ]);
                            
                            // Generate the table
                            doc.autoTable({
                                head: [tableColumn],
                                body: tableRows,
                                startY: yPosition,
                                theme: 'grid',
                                headStyles: {
                                    fillColor: [26, 42, 108],
                                    textColor: [255, 255, 255]
                                },
                                foot: [['TOTAL', '', '', '', `RF ${order.totalAmount}`]],
                                footStyles: {
                                    fillColor: [253, 187, 45],
                                    textColor: [0, 0, 0]
                                }
                            });
                            
                            yPosition = doc.lastAutoTable.finalY + 15;
                            
                            // Add page number
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            doc.text(`Page ${currentPage}`, 105, 280, { align: 'center' });
                        });
                        
                        // Save the PDF
                        doc.save(`All_Invoices_${new Date().toISOString().slice(0, 10)}.pdf`);
                    });
                });
            }
            
            function viewAllData() {
                const dataView = document.getElementById('admin-data-view');
                dataView.innerHTML = '<p>Loading data...</p>';
                
                // Get all data from Firebase
                Promise.all([
                    database.ref('customers').once('value'),
                    database.ref('orders').once('value'),
                    database.ref('trips').once('value'),
                    database.ref('productsWithFees').once('value'),
                    database.ref('islands').once('value')
                ]).then(([customers, orders, trips, products, islands]) => {
                    let html = `
                        <h3>System Data Overview</h3>
                        <div class="dashboard-cards">
                            <div class="dashboard-card">
                                <h3>Customers</h3>
                                <div class="value">${customers.numChildren()}</div>
                            </div>
                            <div class="dashboard-card">
                                <h3>Orders</h3>
                                <div class="value">${orders.numChildren()}</div>
                            </div>
                            <div class="dashboard-card">
                                <h3>Trips</h3>
                                <div class="value">${trips.numChildren()}</div>
                            </div>
                            <div class="dashboard-card">
                                <h3>Products</h3>
                                <div class="value">${products.numChildren()}</div>
                            </div>
                            <div class="dashboard-card">
                                <h3>Islands</h3>
                                <div class="value">${islands.val() ? islands.val().length : 0}</div>
                            </div>
                        </div>
                        
                        <h3>Recent Orders</h3>
                    `;
                    
                    // Show recent orders
                    const ordersData = orders.val();
                    if (ordersData) {
                        html += '<table class="customer-table"><thead><tr><th>ID</th><th>Customer</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
                        
                        // Get last 10 orders
                        const orderKeys = Object.keys(ordersData).slice(-10);
                        orderKeys.reverse().forEach(key => {
                            const order = ordersData[key];
                            const customer = customers.val() ? customers.val()[order.customerId] : null;
                            
                            html += `
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${customer ? customer.name : 'Unknown'}</td>
                                    <td>${new Date(order.date).toLocaleDateString()}</td>
                                    <td>RF ${order.totalAmount}</td>
                                    <td>${order.paymentStatus}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No orders found.</p>';
                    }
                    
                    dataView.innerHTML = html;
                });
            }
            
            // Update dashboard with statistics
            function updateDashboard() {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const tripFilter = document.getElementById('trip-filter').value;
                
                getOrders((orders) => {
                    // Filter orders by date if dates are selected
                    let filteredOrders = orders;
                    if (startDate && endDate) {
                        filteredOrders = orders.filter(order => {
                            const orderDate = new Date(order.date);
                            const start = new Date(startDate);
                            const end = new Date(endDate);
                            end.setDate(end.getDate() + 1); // Include end date
                            return orderDate >= start && orderDate <= end;
                        });
                    }
                    
                    // Filter by trip if selected
                    if (tripFilter !== 'all') {
                        filteredOrders = filteredOrders.filter(order => order.tripId == tripFilter);
                    }
                    
                    // Calculate totals
                    let totalProducts = 0;
                    let totalOrders = filteredOrders.length;
                    let totalRevenue = 0;
                    let pendingBills = 0;
                    
                    // Count products and revenue
                    filteredOrders.forEach(order => {
                        if (order.paymentStatus === 'unpaid') {
                            pendingBills += parseFloat(order.totalAmount) || 0;
                        } else {
                            totalRevenue += parseFloat(order.totalAmount) || 0;
                        }
                        order.products.forEach(product => {
                            totalProducts += parseInt(product.qty) || 0;
                        });
                    });
                    
                    // Update dashboard values
                    document.getElementById('total-products').textContent = totalProducts;
                    document.getElementById('total-orders').textContent = totalOrders;
                    document.getElementById('total-revenue').textContent = 'RF ' + totalRevenue.toFixed(2);
                    document.getElementById('pending-bills').textContent = 'RF ' + pendingBills.toFixed(2);
                    
                    // Update charts
                    updateProductsChart(filteredOrders);
                    updateIslandsChart(filteredOrders);
                    updatePaymentMethodsChart(filteredOrders);
                });
            }
            
            function updateProductsChart(orders) {
                // Count products by type
                const productCounts = {};
                
                orders.forEach(order => {
                    order.products.forEach(product => {
                        if (!productCounts[product.productName]) {
                            productCounts[product.productName] = 0;
                        }
                        productCounts[product.productName] += parseInt(product.qty) || 0;
                    });
                });
                
                const ctx = document.getElementById('products-chart').getContext('2d');
                
                // Destroy previous chart if it exists
                if (productsChart) {
                    productsChart.destroy();
                }
                
                productsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(productCounts),
                        datasets: [{
                            label: 'Products Delivered',
                            data: Object.values(productCounts),
                            backgroundColor: [
                                'rgba(26, 42, 108, 0.7)',
                                'rgba(178, 31, 31, 0.7)',
                                'rgba(253, 187, 45, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(23, 162, 184, 0.7)',
                                'rgba(108, 117, 125, 0.7)'
                            ],
                            borderColor: [
                                'rgba(26, 42, 108, 1)',
                                'rgba(178, 31, 31, 1)',
                                'rgba(253, 187, 45, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(108, 117, 125, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            function updateIslandsChart(orders) {
                // Count orders by island
                const islandCounts = {};
                
                orders.forEach(order => {
                    // Get customer island
                    database.ref('customers/' + order.customerId).once('value').then((snapshot) => {
                        const customer = snapshot.val();
                        if (customer && customer.island) {
                            if (!islandCounts[customer.island]) {
                                islandCounts[customer.island] = 0;
                            }
                            islandCounts[customer.island] += 1;
                            
                            // Update chart when all data is processed
                            if (Object.keys(islandCounts).length > 0) {
                                const ctx = document.getElementById('islands-chart').getContext('2d');
                                
                                // Destroy previous chart if it exists
                                if (islandsChart) {
                                    islandsChart.destroy();
                                }
                                
                                islandsChart = new Chart(ctx, {
                                    type: 'pie',
                                    data: {
                                        labels: Object.keys(islandCounts),
                                        datasets: [{
                                            label: 'Orders by Island',
                                            data: Object.values(islandCounts),
                                            backgroundColor: [
                                'rgba(26, 42, 108, 0.7)',
                                'rgba(178, 31, 31, 0.7)',
                                'rgba(253, 187, 45, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(23, 162, 184, 0.7)',
                                'rgba(108, 117, 125, 0.7)'
                            ],
                                            borderColor: [
                                'rgba(26, 42, 108, 1)',
                                'rgba(178, 31, 31, 1)',
                                'rgba(253, 187, 45, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(108, 117, 125, 1)'
                            ],
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true
                                    }
                                });
                            }
                        }
                    });
                });
            }
            
            function updatePaymentMethodsChart(orders) {
                // Count payment methods
                const paymentMethods = {
                    'cash': 0,
                    'transfer': 0,
                    'card': 0,
                    'not-paid': 0
                };
                
                orders.forEach(order => {
                    if (order.paymentMethod && paymentMethods.hasOwnProperty(order.paymentMethod)) {
                        paymentMethods[order.paymentMethod] += 1;
                    }
                });
                
                const ctx = document.getElementById('payment-methods-chart').getContext('2d');
                
                // Destroy previous chart if it exists
                if (paymentMethodsChart) {
                    paymentMethodsChart.destroy();
                }
                
                paymentMethodsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cash', 'Transfer', 'Card', 'Not Paid'],
                        datasets: [{
                            label: 'Payment Methods',
                            data: [
                                paymentMethods['cash'],
                                paymentMethods['transfer'],
                                paymentMethods['card'],
                                paymentMethods['not-paid']
                            ],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                                               'rgba(23, 162, 184, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
            
            // Load customers for selection in the form section
            function loadCustomersForSelection() {
                // This function would load customers for any selection dropdowns in the form section
                // Currently not implemented as the form section uses island-based customer loading
            }
        }); 
    </script>
</body>
</html>