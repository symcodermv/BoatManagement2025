<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boat Trip Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Custom font for the header */
        @font-face {
            font-family: 'SameeAvasThaana';
            src: url('fonts/Samee_Avas_Thaana.ttf');
        }
        
        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .splash-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        .splash-logo i {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        .splash-logo h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            font-family: 'SameeAvasThaana', sans-serif;
        }
        
        .splash-logo p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .progress-bar {
            width: 80%;
            max-width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 30px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            width: 0%;
            background: white;
            border-radius: 3px;
            transition: width 2s ease-in-out;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Main App Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 10px;
            color: #333;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        header {
            background: #1a2a6c;
            color: white;
            padding: 12px;
            text-align: center;
            position: relative;
        }
        
        .menu-toggle {
            position: absolute;
            left: 15px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
        }
        
        .logo i {
            font-size: 2.2rem;
            margin-right: 8px;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-family: 'SameeAvasThaana', sans-serif;
        }
        
        .tabs {
            display: flex;
            background: #0d1b4b;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 10px 12px;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            min-width: 100px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .tab.active {
            background: #fdbb2d;
            color: #1a2a6c;
        }
        
        .tab:hover:not(.active) {
            background: #2a3b7c;
        }
        
        .content {
            padding: 15px;
        }
        
        .form-section, .pos-section, .island-section, .payment-section, .product-section, .dashboard-section, .boatfee-section {
            display: none;
        }
        
        .form-section.active, .pos-section.active, .island-section.active, .payment-section.active, .product-section.active, .dashboard-section.active, .boatfee-section.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -5px 10px;
        }
        
        .form-group {
            flex: 1 0 100%;
            margin: 0 5px 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1a2a6c;
            font-size: 13px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1a2a6c;
            outline: none;
        }
        
        .product-details {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .product-header {
            display: none;
            flex-wrap: wrap;
            margin-bottom: 10px;
            font-weight: bold;
            color: #1a2a6c;
            padding: 0 5px;
            font-size: 13px;
        }
        
        .product-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            align-items: center;
            background: white;
            padding: 8px;
            border-radius: 8px;
            position: relative;
        }
        
        .product-name {
            flex: 1 0 100%;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-unit {
            flex: 1;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-qty {
            flex: 1;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-price {
            flex: 1;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-desc {
            flex: 1 0 100%;
            padding: 0 5px;
            margin-bottom: 8px;
        }
        
        .product-actions {
            flex: 1;
            padding: 0 5px;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1a2a6c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2a3b7c;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-sm {
            padding: 6px 8px;
            font-size: 12px;
        }
        
        .btn-xs {
            padding: 4px 6px;
            font-size: 11px;
        }
        
        .payment-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .payment-status label {
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .payment-status input {
            width: auto;
            margin-right: 5px;
        }
        
        .status-radio {
            display: flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }
        
        .actions {
            text-align: center;
            margin-top: 15px;
        }
        
        /* Island Management Styles */
        .island-management, .product-management, .boatfee-management {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .island-form, .product-form, .boatfee-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .island-form input, .product-form input, .boatfee-form input {
            flex: 1;
            min-width: 120px;
        }
        
        .island-list, .product-list, .boatfee-list {
            background: white;
            border-radius: 8px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .island-item, .product-item, .boatfee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .island-item:last-child, .product-item:last-child, .boatfee-item:last-child {
            border-bottom: none;
        }
        
        /* POS System Styles */
        .island-selector {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .island-selector select {
            max-width: 100%;
            margin: 0 auto 10px;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
        }
        
        .pos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .trip-list {
            flex: 1;
            min-width: 100%;
            background: #f5f7ff;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .trip-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .trip-card.selected {
            border: 2px solid #1a2a6c;
            background: #e6e9ff;
        }
        
        .trip-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        
        .trip-island {
            font-weight: bold;
            color: #1a2a6c;
            font-size: 14px;
        }
        
        .trip-date {
            color: #666;
            font-size: 13px;
        }
        
        .trip-customer {
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .trip-products {
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 12px;
        }
        
        .trip-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #ddd;
            flex-wrap: wrap;
        }
        
        .trip-status {
            padding: 3px 6px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        
        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .trip-amount {
            font-weight: bold;
            color: #1a2a6c;
            font-size: 14px;
        }
        
        .trip-actions {
            display: flex;
            gap: 6px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .invoice-preview {
            flex: 1;
            min-width: 100%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .invoice-products {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
            min-width: 500px;
        }
        
        .invoice-products th {
            background: #f5f7ff;
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-size: 12px;
        }
        
        .invoice-products td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        
        .invoice-total {
            text-align: right;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            padding: 10px;
            background: #f5f7ff;
            border-radius: 6px;
        }
        
        .invoice-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .bank-details {
            margin-top: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 12px;
        }
        
        /* Payment Management Styles */
        .payment-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .payment-filter {
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .payment-filter.active {
            background: #1a2a6c;
            color: white;
        }
        
        .payment-filter:hover:not(.active) {
            background: #2a3b7c;
            color: white;
        }
        
        .payment-list {
            background: #f5f7ff;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .payment-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .payment-info {
            flex: 2;
            margin-bottom: 8px;
        }
        
        .payment-amount {
            flex: 1;
            text-align: right;
            font-weight: bold;
            font-size: 14px;
            color: #1a2a6c;
            margin-bottom: 8px;
        }
        
        .payment-actions {
            flex: 1;
            text-align: right;
        }
        
        /* Customer Registration Form */
        .customer-registration {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Customer List Styles */
        .customer-list {
            margin-top: 20px;
        }
        
        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .customer-table th, .customer-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .customer-table th {
            background-color: #1a2a6c;
            color: white;
        }
        
        .customer-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Mobile-specific styles */
        .mobile-product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .mobile-product-row {
            display: contents;
        }
        
        /* Dashboard Styles */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background: #f5f7ff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card h3 {
            color: #1a2a6c;
            margin-bottom: 10px;
        }
        
        .dashboard-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #1a2a6c;
        }
        
        .dashboard-card .subtext {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container h3 {
            color: #1a2a6c;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Date Filter Styles */
        .date-filter {
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .date-filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 120px;
        }
        
        /* Mobile sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: #1a2a6c;
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            padding-top: 60px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        
        .sidebar.open {
            left: 0;
            display: block;
        }
        
        .sidebar .tab {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .tab.active {
            background: #fdbb2d;
            color: #1a2a6c;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .overlay.open {
            display: block;
        }
        
        /* Island customers list */
        .island-customers {
            margin-top: 15px;
            background: #f5f7ff;
            padding: 12px;
            border-radius: 8px;
        }
        
        .island-customer-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        
        .island-customer-item:hover {
            background-color: #e6e9ff;
        }
        
        .island-customer-item:last-child {
            border-bottom: none;
        }
        
        .island-total {
            margin-top: 10px;
            padding: 10px;
            background: #1a2a6c;
            color: white;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        
        /* Mobile invoice styles */
        @media (max-width: 767px) {
            .invoice-products th:nth-child(4),
            .invoice-products td:nth-child(4) {
                display: none;
            }
            
            .invoice-products th:nth-child(4)::before {
                content: "Boat Fee";
                display: table-cell;
            }
            
            .invoice-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .invoice-actions .btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .customer-table {
                font-size: 11px;
            }
            
            .customer-table th, .customer-table td {
                padding: 5px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .tabs {
                display: none;
            }
        }
        
        /* Print styles for invoice */
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-preview, .invoice-preview * {
                visibility: visible;
            }
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
            .invoice-actions {
                display: none;
            }
        }
        
        /* Media queries for larger screens */
        @media (min-width: 768px) {
            body {
                padding: 15px;
                font-size: 16px;
            }
            
            .container {
                max-width: 95%;
            }
            
            header {
                padding: 15px;
            }
            
            .logo i {
                font-size: 3rem;
            }
            
            h1 {
                font-size: 2.8rem;
            }
            
            .tab {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-group {
                flex: 1 0 calc(50% - 10px);
            }
            
            .product-header {
                display: flex;
            }
            
            .product-name, .product-unit, .product-qty, .product-price, .product-desc, .product-actions {
                margin-bottom: 0;
                flex: 1;
            }
            
            .product-name {
                flex: 2;
            }
            
            .product-desc {
                flex: 2;
            }
            
            .trip-list, .invoice-preview {
                min-width: calc(50% - 8px);
            }
            
            .payment-info, .payment-amount, .payment-actions {
                margin-bottom: 0;
            }
            
            .mobile-product-grid {
                display: block;
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                max-width: 1300px;
            }
            
            .form-group {
                flex: 1 0 calc(33.333% - 10px);
            }
        }
        
        /* Total trips value display */
        .total-trips-value {
            background: #1a2a6c;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Customer Selection Styles */
        .customer-selection {
            margin-bottom: 15px;
        }
        
        .customer-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        /* Trip Number Styles */
        .trip-number-input {
            display: flex;
            align-items: center;
        }
        
        .trip-number-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        /* Boat Fee Styles */
        .boat-fee-input {
            display: flex;
            align-items: center;
        }
        
        .boat-fee-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        /* Edit and Delete buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-ship"></i>
            <h1>qTOb amAyin</h1>
            <p>Boat Trip Management System</p>
        </div>
        <div class="progress-bar">
            <div class="progress" id="splash-progress"></div>
        </div>
    </div>
    
    <!-- Mobile Sidebar -->
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="form">Entry Form</div>
        <div class="tab" data-tab="pos">POS System</div>
        <div class="tab" data-tab="island">Island Management</div>
        <div class="tab" data-tab="product">Product Management</div>
        <div class="tab" data-tab="boatfee">Boat Fee Management</div>
        <div class="tab" data-tab="payment">Payment Management</div>
    </div>
    
    <!-- Main App Container -->
    <div class="container">
        <header>
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-ship"></i>
                <h1>qTOb amAyin</h1>
            </div>
            <p>Manage your boat trips, customers, and invoices in one place</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="form">Entry Form</div>
            <div class="tab" data-tab="pos">POS System</div>
            <div class="tab" data-tab="island">Island Management</div>
            <div class="tab" data-tab="product">Product Management</div>
            <div class="tab" data-tab="boatfee">Boat Fee Management</div>
            <div class="tab" data-tab="payment">Payment Management</div>
        </div>
        
        <div class="content">
            <!-- Dashboard Section -->
            <div class="dashboard-section active" id="dashboard-section">
                <h2>Dashboard</h2>
                <p>Overview of your boat trip business</p>
                
                <!-- Date Filter -->
                <div class="date-filter">
                    <div class="date-filter-group">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="date-filter-group">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date">
                    </div>
                    <div class="date-filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" id="apply-filter">Apply Filter</button>
                    </div>
                    <div class="date-filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-warning" id="reset-filter">Reset Filter</button>
                    </div>
                </div>
                
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <h3>Total Products</h3>
                        <div class="value" id="total-products">0</div>
                        <div class="subtext">All products delivered</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Total Boat Fees</h3>
                        <div class="value" id="total-boatfees">0</div>
                        <div class="subtext">Total boat trips</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Total Orders</h3>
                        <div class="value" id="total-orders">0</div>
                        <div class="subtext">All customer orders</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Total Revenue</h3>
                        <div class="value" id="total-revenue">RF 0</div>
                        <div class="subtext">From all trips</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Pending Bills</h3>
                        <div class="value" id="pending-bills">RF 0</div>
                        <div class="subtext">Unpaid orders</div>
                    </div>
                </div>
                
                <div class="dashboard-charts">
                    <div class="chart-container">
                        <h3>Products Distribution</h3>
                        <canvas id="products-chart" height="250"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Island-wise Orders</h3>
                        <canvas id="islands-chart" height="250"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Payment Methods</h3>
                        <canvas id="payment-methods-chart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Entry Form Section -->
            <div class="form-section" id="form-section">
                <div class="island-selector">
                    <label for="island">Select Island</label>
                    <select id="island" required>
                        <option value="">Select an island</option>
                        <!-- Islands will be loaded from Firebase -->
                    </select>
                </div>
                
                <!-- Island Customers List -->
                <div class="island-customers" id="island-customers" style="display: none;">
                    <h3>Customers in <span id="selected-island-name"></span></h3>
                    <div id="island-customers-list">
                        <!-- Customers will be listed here -->
                    </div>
                    <div class="island-total" id="island-total">
                        Total Value: RF 0
                    </div>
                </div>
                
                <!-- Customer Registration Form (Initially Hidden) -->
                <div class="customer-registration" id="customer-registration" style="display: none;">
                    <h3>Customer Registration</h3>
                    <form id="customer-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customer-name">Customer/Business Name</label>
                                <input type="text" id="customer-name" placeholder="Enter customer name" required>
                            </div>
                            <div class="form-group">
                                <label for="contact">Contact</label>
                                <input type="text" id="contact" placeholder="Enter contact number" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <textarea id="address" placeholder="Enter customer address"></textarea>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-success">Save Customer</button>
                            <button type="button" class="btn btn-warning" id="add-products-btn">Add Products</button>
                        </div>
                    </form>
                </div>
                
                <!-- Product Entry Form (Initially Hidden) -->
                <div class="product-details" id="product-details" style="display: none;">
                    <h3>Product Details</h3>
                    <form id="product-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="trip-number">Trip Number</label>
                                <div class="trip-number-input">
                                    <input type="text" id="trip-number" placeholder="Enter trip number" required>
                                    <button type="button" class="btn btn-primary" id="generate-trip-number">Generate</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="product-date">Select Date</label>
                                <input type="date" id="product-date" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-time">Select Time</label>
                                <input type="time" id="product-time" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-select">Select Product</label>
                                <select id="product-select" required>
                                    <option value="">Select a product</option>
                                    <!-- Products will be loaded from Firebase -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="product-unit">Unit</label>
                                <select id="product-unit" required>
                                    <option value="kg">Kg</option>
                                    <option value="pcs">Pcs</option>
                                    <option value="foot">Foot</option>
                                    <option value="ltr">Ltr</option>
                                    <option value="case">Case</option>
                                    <option value="dozen">Dozen</option>
                                    <option value="can">Can</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-qty-input">Quantity</label>
                                <input type="number" id="product-qty-input" placeholder="Quantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="product-boat-fee">Boat Fee for this product</label>
                                <select id="product-boat-fee" required>
                                    <option value="">Select Boat Fee</option>
                                    <!-- Boat Fees will be loaded from Firebase -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-desc-input">Description (Optional)</label>
                                <textarea id="product-desc-input" placeholder="Product description"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="payment-method">Payment Method</label>
                                <select id="payment-method" required>
                                    <option value="cash">Cash</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="card">Card</option>
                                    <option value="not-paid">Not Paid</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-success">Add Product</button>
                            <button type="button" class="btn btn-primary" id="finish-order-btn">Finish Order</button>
                        </div>
                    </form>
                    
                    <div class="product-list-table" id="product-list-table" style="margin-top: 20px; display: none;">
                        <h4>Added Products</h4>
                        <table class="customer-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Boat Fee</th>
                                    <th>Trip No</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="added-products-table">
                                <!-- Added products will be listed here -->
                            </tbody>
                        </table>
                        <div class="total-trips-value" id="order-total">
                            Order Total: RF 0
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- POS System Section -->
            <div class="pos-section" id="pos-section">
                <div class="island-selector">
                    <label for="pos-island">Select Island to View Customers:</label>
                    <select id="pos-island">
                        <option value="all">All Islands</option>
                        <!-- Islands will be loaded from Firebase -->
                    </select>
                </div>
                
                <div class="search-container">
                    <input type="text" id="search-customers" placeholder="Search by customer name or contact...">
                </div>
                
                <div class="customer-list" id="customer-list">
                    <h3>Customers</h3>
                    <table class="customer-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Contact</th>
                                <th>Island</th>
                                <th>Orders</th>
                                <th>Total Value (RF)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                            <!-- Customers will be listed here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Customer Orders Modal -->
                <div id="customer-orders-modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2 id="modal-customer-name">Customer Orders</h2>
                        <div id="customer-orders-list">
                            <!-- Customer orders will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Island Management Section -->
            <div class="island-section" id="island-section">
                <h2>Island Management</h2>
                <p>Add and remove islands for your boat trips</p>
                
                <div class="island-management">
                    <div class="island-form">
                        <input type="text" id="new-island" placeholder="Enter new island name">
                        <button class="btn btn-primary" id="add-island"><i class="fas fa-plus"></i> Add Island</button>
                    </div>
                    
                    <div class="island-list" id="island-list">
                        <h3>Available Islands</h3>
                        <!-- Islands will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Product Management Section -->
            <div class="product-section" id="product-section">
                <h2>Product Management</h2>
                <p>Add and remove products for your boat trips</p>
                
                <div class="product-management">
                    <div class="product-form">
                        <input type="text" id="new-product" placeholder="Enter new product name">
                        <input type="text" id="new-product-boatfee" placeholder="Default Boat Fee">
                        <button class="btn btn-primary" id="add-product"><i class="fas fa-plus"></i> Add Product</button>
                    </div>
                    
                    <div class="product-list" id="product-list">
                        <h3>Available Products</h3>
                        <!-- Products will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Boat Fee Management Section -->
            <div class="boatfee-section" id="boatfee-section">
                <h2>Boat Fee Management</h2>
                <p>Add and remove boat fees for your products</p>
                
                <div class="boatfee-management">
                    <div class="boatfee-form">
                        <input type="text" id="new-boatfee" placeholder="Enter new boat fee">
                        <input type="number" id="new-boatfee-amount" placeholder="Fee Amount (RF)" step="0.01" min="0">
                        <button class="btn btn-primary" id="add-boatfee"><i class="fas fa-plus"></i> Add Boat Fee</button>
                    </div>
                    
                    <div class="boatfee-list" id="boatfee-list">
                        <h3>Available Boat Fees</h3>
                        <!-- Boat Fees will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Payment Management Section -->
            <div class="payment-section" id="payment-section">
                <h2>Payment Management</h2>
                <p>View and manage payments for your boat trips</p>
                
                <div class="payment-filters">
                    <div class="payment-filter active" data-filter="all">All Payments</div>
                    <div class="payment-filter" data-filter="paid">Paid</div>
                    <div class="payment-filter" data-filter="unpaid">Unpaid</div>
                </div>
                
                <div class="payment-list" id="payment-list">
                    <!-- Payment items will be listed here -->
                </div>
                
                <div class="total-trips-value" id="payment-total">
                    Total Value: RF 0
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyipnhQ_PhDyTD490RgshfgSpioXq37eA",
            authDomain: "boatmanagementsystem-5ffba.firebaseapp.com",
            databaseURL: "https://boatmanagementsystem-5ffba-default-rtdb.firebaseio.com",
            projectId: "boatmanagementsystem-5ffba",
            storageBucket: "boatmanagementsystem-5ffba.firebasestorage.app",
            messagingSenderId: "4668108280",
            appId: "1:4668108280:web:b8c0504ccf7a4df2c17a0d",
            measurementId: "G-WZ1LGR0W5Z"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentCustomerId = null;
        let currentIsland = null;
        let customerProducts = [];
        let tripNumber = "";
        let productsChart = null;
        let islandsChart = null;
        let paymentMethodsChart = null;
        let currentOrderId = null;
        let tripCounter = 1;
        let productBoatFees = {};
        let boatFeeAmounts = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Show splash screen first
            const splashScreen = document.getElementById('splash-screen');
            const progressBar = document.getElementById('splash-progress');
            const container = document.querySelector('.container');
            
            // Simulate loading progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    // Hide splash screen and show main app
                    splashScreen.style.opacity = '0';
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                        container.style.opacity = '1';
                        container.style.transform = 'translateY(0)';
                        
                        // Initialize data after splash screen
                        initializeData();
                    }, 500);
                }
            }, 100);
            
            // Mobile sidebar functionality
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            });
            
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            });
            
            // Tab switching functionality
            const tabs = document.querySelectorAll('.tab');
            const dashboardSection = document.getElementById('dashboard-section');
            const formSection = document.getElementById('form-section');
            const posSection = document.getElementById('pos-section');
            const islandSection = document.getElementById('island-section');
            const productSection = document.getElementById('product-section');
            const boatfeeSection = document.getElementById('boatfee-section');
            const paymentSection = document.getElementById('payment-section');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    dashboardSection.classList.remove('active');
                    formSection.classList.remove('active');
                    posSection.classList.remove('active');
                    islandSection.classList.remove('active');
                    productSection.classList.remove('active');
                    boatfeeSection.classList.remove('active');
                    paymentSection.classList.remove('active');
                    
                    if (this.dataset.tab === 'dashboard') {
                        dashboardSection.classList.add('active');
                        updateDashboard();
                    } else if (this.dataset.tab === 'form') {
                        formSection.classList.add('active');
                        loadCustomersForSelection();
                    } else if (this.dataset.tab === 'pos') {
                        posSection.classList.add('active');
                        loadCustomers();
                    } else if (this.dataset.tab === 'island') {
                        islandSection.classList.add('active');
                        loadIslands();
                    } else if (this.dataset.tab === 'product') {
                        productSection.classList.add('active');
                        loadProducts();
                    } else if (this.dataset.tab === 'boatfee') {
                        boatfeeSection.classList.add('active');
                        loadBoatFees();
                    } else if (this.dataset.tab === 'payment') {
                        paymentSection.classList.add('active');
                        loadPayments('all');
                    }
                    
                    // Close sidebar on mobile after selection
                    sidebar.classList.remove('open');
                    overlay.classList.remove('open');
                });
            });
            
            // Island selection change in form section
            document.getElementById('island').addEventListener('change', function() {
                currentIsland = this.value;
                if (currentIsland) {
                    document.getElementById('island-customers').style.display = 'block';
                    document.getElementById('selected-island-name').textContent = currentIsland;
                    loadIslandCustomers(currentIsland);
                } else {
                    document.getElementById('island-customers').style.display = 'none';
                }
            });
            
            // Date filter functionality
            document.getElementById('apply-filter').addEventListener('click', function() {
                updateDashboard();
            });
            
            document.getElementById('reset-filter').addEventListener('click', function() {
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                updateDashboard();
            });
            
            // Payment filter functionality
            const paymentFilters = document.querySelectorAll('.payment-filter');
            paymentFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    paymentFilters.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    loadPayments(this.dataset.filter);
                });
            });
            
            // Add products button
            document.getElementById('add-products-btn').addEventListener('click', function() {
                document.getElementById('product-details').style.display = 'block';
            });
            
            // Generate trip number
            document.getElementById('generate-trip-number').addEventListener('click', function() {
                const date = new Date();
                const year = date.getFullYear().toString().substr(-2);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                
                // Get the next trip number for this year/month
                database.ref('tripCounter/' + year + month).once('value').then((snapshot) => {
                    let counter = snapshot.val() || 1;
                    tripNumber = `TR${year}${month}/${counter.toString().padStart(3, '0')}`;
                    document.getElementById('trip-number').value = tripNumber;
                    
                    // Increment the counter for next time
                    database.ref('tripCounter/' + year + month).set(counter + 1);
                });
            });
            
            // Product selection change - auto-fill boat fee
            document.getElementById('product-select').addEventListener('change', function() {
                const productName = this.value;
                if (productName && productBoatFees[productName]) {
                    // Auto-select boat fee if available
                    document.getElementById('product-boat-fee').value = productBoatFees[productName];
                }
            });
            
            // Product form submission
            document.getElementById('product-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!currentCustomerId) {
                    alert('Please select a customer first!');
                    return;
                }
                
                if (!tripNumber) {
                    alert('Please generate a trip number first!');
                    return;
                }
                
                const productId = document.getElementById('product-select').value;
                const productName = document.getElementById('product-select').options[document.getElementById('product-select').selectedIndex].text;
                const unit = document.getElementById('product-unit').value;
                const qty = document.getElementById('product-qty-input').value;
                const description = document.getElementById('product-desc-input').value;
                const date = document.getElementById('product-date').value;
                const time = document.getElementById('product-time').value;
                const paymentMethod = document.getElementById('payment-method').value;
                const productBoatFee = document.getElementById('product-boat-fee').value;
                
                if (!productId || !qty || !productBoatFee) {
                    alert('Please select a product, enter quantity, and select boat fee!');
                    return;
                }
                
                // Calculate boat fee amount
                const boatFeeAmount = boatFeeAmounts[productBoatFee] || 0;
                const subtotal = (parseFloat(qty) * parseFloat(boatFeeAmount)).toFixed(2);
                
                // Add product to the list
                customerProducts.push({
                    productId,
                    productName,
                    unit,
                    qty,
                    boatFee: productBoatFee,
                    boatFeeAmount: boatFeeAmount,
                    subtotal,
                    description,
                    date,
                    time,
                    tripNumber,
                    paymentMethod
                });
                
                // Update the products table
                updateProductsTable();
                
                // Reset form
                document.getElementById('product-select').value = '';
                document.getElementById('product-qty-input').value = '1';
                document.getElementById('product-desc-input').value = '';
                document.getElementById('product-boat-fee').value = '';
                document.getElementById('product-date').valueAsDate = new Date();
                
                alert('Product added to order!');
            });
            
            // Finish order button
            document.getElementById('finish-order-btn').addEventListener('click', function() {
                if (customerProducts.length === 0) {
                    alert('Please add at least one product to the order!');
                    return;
                }
                
                // Calculate total amount
                const totalAmount = customerProducts.reduce((sum, product) => {
                    return sum + parseFloat(product.subtotal);
                }, 0).toFixed(2);
                
                // Create order object
                const order = {
                    id: currentOrderId || Date.now(), // Use existing ID if editing
                    customerId: currentCustomerId,
                    products: customerProducts,
                    date: new Date().toISOString(),
                    paymentStatus: document.getElementById('payment-method').value === 'not-paid' ? 'unpaid' : 'paid',
                    tripNumber: tripNumber,
                    totalAmount: totalAmount,
                    paymentMethod: document.getElementById('payment-method').value
                };
                
                // Save to Firebase
                saveOrder(order);
                
                // Reset forms
                document.getElementById('customer-form').reset();
                document.getElementById('product-form').reset();
                document.getElementById('customer-registration').style.display = 'none';
                document.getElementById('product-details').style.display = 'none';
                document.getElementById('product-list-table').style.display = 'none';
                document.getElementById('island-customers').style.display = 'block';
                
                // Reset variables
                currentCustomerId = null;
                customerProducts = [];
                tripNumber = "";
                currentOrderId = null;
                
                // Update island customers list
                loadIslandCustomers(currentIsland);
                
                alert('Order saved successfully!');
            });
            
            // Add island functionality
            document.getElementById('add-island').addEventListener('click', function() {
                const islandName = document.getElementById('new-island').value.trim();
                if (islandName) {
                    addIsland(islandName);
                    document.getElementById('new-island').value = '';
                } else {
                    alert('Please enter an island name!');
                }
            });
            
            // Add product functionality
            document.getElementById('add-product').addEventListener('click', function() {
                const productName = document.getElementById('new-product').value.trim();
                const productBoatFee = document.getElementById('new-product-boatfee').value.trim();
                
                if (productName && productBoatFee) {
                    addProduct(productName, productBoatFee);
                    document.getElementById('new-product').value = '';
                    document.getElementById('new-product-boatfee').value = '';
                } else {
                    alert('Please enter a product name and boat fee!');
                }
            });
            
            // Add boat fee functionality
            document.getElementById('add-boatfee').addEventListener('click', function() {
                const boatFeeName = document.getElementById('new-boatfee').value.trim();
                const boatFeeAmount = document.getElementById('new-boatfee-amount').value;
                
                if (boatFeeName && boatFeeAmount) {
                    addBoatFee(boatFeeName, boatFeeAmount);
                    document.getElementById('new-boatfee').value = '';
                    document.getElementById('new-boatfee-amount').value = '';
                } else {
                    alert('Please enter a boat fee name and amount!');
                }
            });
            
            // POS Island filter
            document.getElementById('pos-island').addEventListener('change', loadCustomers);
            
            // Search functionality
            document.getElementById('search-customers').addEventListener('input', function() {
                loadCustomers(this.value);
            });
            
            // Modal close functionality
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('customer-orders-modal').style.display = 'none';
            });
            
            // Initialize with today's date
            document.getElementById('product-date').valueAsDate = new Date();
            
            // Data functions
            function initializeData() {
                // Load islands, products, and boat fees from Firebase
                loadIslandsFromFirebase();
                loadProductsFromFirebase();
                loadBoatFeesFromFirebase();
                
                // Set up real-time listeners
                database.ref('customers').on('value', () => {
                    loadCustomers();
                    loadCustomersForSelection();
                });
                database.ref('orders').on('value', () => {
                    loadCustomers();
                    updateDashboard();
                });
            }
            
            function loadIslandCustomers(islandName) {
                const islandCustomersList = document.getElementById('island-customers-list');
                islandCustomersList.innerHTML = '';
                
                let totalValue = 0;
                
                // Get customers from this island
                getCustomers((customers) => {
                    const islandCustomers = customers.filter(customer => customer.island === islandName);
                    
                    if (islandCustomers.length === 0) {
                        islandCustomersList.innerHTML = '<p>No customers found for this island.</p>';
                        document.getElementById('island-total').textContent = 'Total Value: RF 0';
                        return;
                    }
                    
                    // Get orders to calculate total value
                    getOrders((orders) => {
                        islandCustomers.forEach(customer => {
                            const customerOrders = orders.filter(order => order.customerId == customer.id);
                            const customerTotal = customerOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            totalValue += customerTotal;
                            
                            const customerItem = document.createElement('div');
                            customerItem.className = 'island-customer-item';
                            customerItem.dataset.customerId = customer.id;
                            customerItem.innerHTML = `
                                <div>${customer.name} (${customer.contact})</div>
                                <div>RF ${customerTotal.toFixed(2)}</div>
                            `;
                            
                            // Add click event to select customer
                            customerItem.addEventListener('click', function() {
                                selectCustomerForEntry(customer.id);
                            });
                            
                            islandCustomersList.appendChild(customerItem);
                        });
                        
                        document.getElementById('island-total').textContent = `Total Value: RF ${totalValue.toFixed(2)}`;
                    });
                });
            }
            
            function selectCustomerForEntry(customerId) {
                currentCustomerId = customerId;
                
                // Load customer details
                database.ref('customers/' + customerId).once('value').then((snapshot) => {
                    const customer = snapshot.val();
                    if (customer) {
                        // Show product entry form
                        document.getElementById('product-details').style.display = 'block';
                        document.getElementById('customer-registration').style.display = 'none';
                        
                        // Generate trip number automatically
                        document.getElementById('generate-trip-number').click();
                        
                        // Load customer orders to continue adding products
                        getCustomerOrders(customerId, (orders) => {
                            if (orders.length > 0) {
                                // Use the latest order
                                const latestOrder = orders[orders.length - 1];
                                currentOrderId = latestOrder.id;
                                tripNumber = latestOrder.tripNumber;
                                
                                document.getElementById('trip-number').value = tripNumber;
                                
                                // Load products if any
                                customerProducts = latestOrder.products || [];
                                updateProductsTable();
                            }
                        });
                    }
                });
            }
            
            function loadIslandsFromFirebase() {
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val();
                    if (!islands) {
                        // Add default islands if none exist
                        const defaultIslands = ['K.Male', 'Dhiggaru', 'Mulah', 'Fuvahmulah'];
                        database.ref('islands').set(defaultIslands).then(() => {
                            updateIslandSelects(defaultIslands);
                        });
                    } else {
                        updateIslandSelects(islands);
                    }
                });
            }
            
            function loadProductsFromFirebase() {
                database.ref('products').once('value').then((snapshot) => {
                    const products = snapshot.val();
                    if (!products) {
                        // Add default products if none exist
                        const defaultProducts = [
                            {name: 'Rice', boatFee: 'Boat 1'},
                            {name: 'Flour', boatFee: 'Boat 1'},
                            {name: 'Sugar', boatFee: 'Boat 2'},
                            {name: 'Oil', boatFee: 'Boat 2'},
                            {name: 'Tea', boatFee: 'Boat 3'}
                        ];
                        
                        // Store product boat fees in global variables
                        defaultProducts.forEach(product => {
                            productBoatFees[product.name] = product.boatFee;
                        });
                        
                        database.ref('products').set(defaultProducts).then(() => {
                            updateProductSelect(defaultProducts);
                        });
                    } else {
                        // Extract product names and boat fees
                        const productNames = products.map(product => product.name);
                        
                        // Store product boat fees in global variables
                        products.forEach(product => {
                            productBoatFees[product.name] = product.boatFee;
                        });
                        
                        updateProductSelect(products);
                    }
                });
            }
            
            function loadBoatFeesFromFirebase() {
                database.ref('boatFees').once('value').then((snapshot) => {
                    const boatFees = snapshot.val();
                    if (!boatFees) {
                        // Add default boat fees if none exist
                        const defaultBoatFees = [
                            {name: 'Boat 1', amount: 50.00},
                            {name: 'Boat 2', amount: 75.00},
                            {name: 'Boat 3', amount: 100.00}
                        ];
                        
                        // Store boat fee amounts in global variables
                        defaultBoatFees.forEach(fee => {
                            boatFeeAmounts[fee.name] = fee.amount;
                        });
                        
                        database.ref('boatFees').set(defaultBoatFees).then(() => {
                            updateBoatFeeSelect(defaultBoatFees);
                        });
                    } else {
                        // Store boat fee amounts in global variables
                        boatFees.forEach(fee => {
                            boatFeeAmounts[fee.name] = fee.amount;
                        });
                        
                        updateBoatFeeSelect(boatFees);
                    }
                });
            }
            
            function updateIslandSelects(islands) {
                const islandSelect = document.getElementById('island');
                const posIslandSelect = document.getElementById('pos-island');
                
                // Clear existing options except the first one
                while (islandSelect.options.length > 1) {
                    islandSelect.remove(1);
                }
                
                while (posIslandSelect.options.length > 1) {
                    posIslandSelect.remove(1);
                }
                
                // Add islands to selects
                islands.forEach(island => {
                    const option = document.createElement('option');
                    option.value = island;
                    option.textContent = island;
                    islandSelect.appendChild(option);
                    
                    const posOption = document.createElement('option');
                    posOption.value = island;
                    posOption.textContent = island;
                    posIslandSelect.appendChild(posOption);
                });
            }
            
            function updateProductSelect(products) {
                const productSelect = document.getElementById('product-select');
                
                // Clear existing options except the first one
                while (productSelect.options.length > 1) {
                    productSelect.remove(1);
                }
                
                // Add products to select
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name || product;
                    option.textContent = product.name || product;
                    productSelect.appendChild(option);
                });
            }
            
            function updateBoatFeeSelect(boatFees) {
                const boatFeeSelect = document.getElementById('product-boat-fee');
                
                // Clear existing options except the first one
                while (boatFeeSelect.options.length > 1) {
                    boatFeeSelect.remove(1);
                }
                
                // Add boat fees to select
                boatFees.forEach(fee => {
                    const option = document.createElement('option');
                    option.value = fee.name;
                    option.textContent = `${fee.name} (RF ${fee.amount})`;
                    boatFeeSelect.appendChild(option);
                });
            }
            
            function loadIslands() {
                const islandList = document.getElementById('island-list');
                
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val();
                    
                    // Clear current list
                    islandList.innerHTML = '<h3>Available Islands</h3>';
                    
                    if (!islands || islands.length === 0) {
                        islandList.innerHTML += '<p>No islands added yet.</p>';
                        return;
                    }
                    
                    // Create island items
                    islands.forEach(island => {
                        const islandItem = document.createElement('div');
                        islandItem.className = 'island-item';
                        islandItem.innerHTML = `
                            <div class="island-name">${island}</div>
                            <button class="btn btn-danger btn-sm delete-island" data-island="${island}"><i class="fas fa-trash"></i> Delete</button>
                        `;
                        
                        islandList.appendChild(islandItem);
                        
                        // Add event listener to delete button
                        islandItem.querySelector('.delete-island').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete ${island}?`)) {
                                deleteIsland(island);
                            }
                        });
                    });
                });
            }
            
            function loadProducts() {
                const productList = document.getElementById('product-list');
                
                database.ref('products').once('value').then((snapshot) => {
                    const products = snapshot.val();
                    
                    // Clear current list
                    productList.innerHTML = '<h3>Available Products</h3>';
                    
                    if (!products || products.length === 0) {
                        productList.innerHTML += '<p>No products added yet.</p>';
                        return;
                    }
                    
                    // Create product items
                    products.forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.className = 'product-item';
                        productItem.innerHTML = `
                            <div class="product-name">${product.name}${product.boatFee ? ' (' + product.boatFee + ')' : ''}</div>
                            <button class="btn btn-danger btn-sm delete-product" data-product="${product.name}"><i class="fas fa-trash"></i> Delete</button>
                        `;
                        
                        productList.appendChild(productItem);
                        
                        // Add event listener to delete button
                        productItem.querySelector('.delete-product').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete ${product.name}?`)) {
                                deleteProduct(product.name);
                            }
                        });
                    });
                });
            }
            
            function loadBoatFees() {
                const boatFeeList = document.getElementById('boatfee-list');
                
                database.ref('boatFees').once('value').then((snapshot) => {
                    const boatFees = snapshot.val();
                    
                    // Clear current list
                    boatFeeList.innerHTML = '<h3>Available Boat Fees</h3>';
                    
                    if (!boatFees || boatFees.length === 0) {
                        boatFeeList.innerHTML += '<p>No boat fees added yet.</p>';
                        return;
                    }
                    
                    // Create boat fee items
                    boatFees.forEach(boatFee => {
                        const boatFeeElement = document.createElement('div');
                        boatFeeElement.className = 'boatfee-item';
                        boatFeeElement.innerHTML = `
                            <div class="boatfee-name">${boatFee.name} - RF ${boatFee.amount.toFixed(2)}</div>
                            <button class="btn btn-danger btn-sm delete-boatfee" data-boatfee="${boatFee.name}"><i class="fas fa-trash"></i> Delete</button>
                        `;
                        
                        boatFeeList.appendChild(boatFeeElement);
                        
                        // Add event listener to delete button
                        boatFeeElement.querySelector('.delete-boatfee').addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete ${boatFee.name}?`)) {
                                deleteBoatFee(boatFee.name);
                            }
                        });
                    });
                });
            }
            
            function addIsland(islandName) {
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val() || [];
                    if (!islands.includes(islandName)) {
                        islands.push(islandName);
                        database.ref('islands').set(islands).then(() => {
                            updateIslandSelects(islands);
                            loadIslands();
                            alert('Island added successfully!');
                        });
                    } else {
                        alert('This island already exists!');
                    }
                });
            }
            
            function deleteIsland(islandName) {
                database.ref('islands').once('value').then((snapshot) => {
                    const islands = snapshot.val();
                    const updatedIslands = islands.filter(island => island !== islandName);
                    database.ref('islands').set(updatedIslands).then(() => {
                        updateIslandSelects(updatedIslands);
                        loadIslands();
                        alert('Island deleted successfully!');
                    });
                });
            }
            
            function addProduct(productName, productBoatFee) {
                database.ref('products').once('value').then((snapshot) => {
                    const products = snapshot.val() || [];
                    
                    // Check if product already exists
                    const productExists = products.some(product => product.name === productName);
                    
                    if (!productExists) {
                        const newProduct = {
                            name: productName,
                            boatFee: productBoatFee
                        };
                        
                        products.push(newProduct);
                        
                        // Update global variables
                        productBoatFees[productName] = productBoatFee;
                        
                        database.ref('products').set(products).then(() => {
                            updateProductSelect(products);
                            loadProducts();
                            alert('Product added successfully!');
                        });
                    } else {
                        alert('This product already exists!');
                    }
                });
            }
            
            function deleteProduct(productName) {
                database.ref('products').once('value').then((snapshot) => {
                    const products = snapshot.val();
                    const updatedProducts = products.filter(product => product.name !== productName);
                    database.ref('products').set(updatedProducts).then(() => {
                        updateProductSelect(updatedProducts);
                        loadProducts();
                        
                        // Remove from global variables
                        delete productBoatFees[productName];
                        
                        alert('Product deleted successfully!');
                    });
                });
            }
            
            function addBoatFee(boatFeeName, boatFeeAmount) {
                database.ref('boatFees').once('value').then((snapshot) => {
                    const boatFees = snapshot.val() || [];
                    
                    // Check if boat fee already exists
                    const boatFeeExists = boatFees.some(fee => fee.name === boatFeeName);
                    
                    if (!boatFeeExists) {
                        boatFees.push({
                            name: boatFeeName,
                            amount: parseFloat(boatFeeAmount)
                        });
                        
                        // Update global variables
                        boatFeeAmounts[boatFeeName] = parseFloat(boatFeeAmount);
                        
                        database.ref('boatFees').set(boatFees).then(() => {
                            updateBoatFeeSelect(boatFees);
                            loadBoatFees();
                            alert('Boat Fee added successfully!');
                        });
                    } else {
                        alert('This boat fee already exists!');
                    }
                });
            }
            
            function deleteBoatFee(boatFeeName) {
                database.ref('boatFees').once('value').then((snapshot) => {
                    const boatFees = snapshot.val();
                    const updatedBoatFees = boatFees.filter(fee => fee.name !== boatFeeName);
                    database.ref('boatFees').set(updatedBoatFees).then(() => {
                        updateBoatFeeSelect(updatedBoatFees);
                        loadBoatFees();
                        
                        // Remove from global variables
                        delete boatFeeAmounts[boatFeeName];
                        
                        alert('Boat Fee deleted successfully!');
                    });
                });
            }
            
            function saveCustomer(customer) {
                database.ref('customers/' + customer.id).set(customer);
            }
            
            function saveOrder(order) {
                database.ref('orders/' + order.id).set(order);
            }
            
            function getCustomers(callback) {
                database.ref('customers').once('value').then((snapshot) => {
                    const customers = snapshot.val();
                    const customersArray = customers ? Object.values(customers) : [];
                    callback(customersArray);
                });
            }
            
            function getOrders(callback) {
                database.ref('orders').once('value').then((snapshot) => {
                    const orders = snapshot.val();
                    const ordersArray = orders ? Object.values(orders) : [];
                    callback(ordersArray);
                });
            }
            
            function getCustomerOrders(customerId, callback) {
                database.ref('orders').once('value').then((snapshot) => {
                    const orders = snapshot.val();
                    const ordersArray = orders ? Object.values(orders) : [];
                    const customerOrders = ordersArray.filter(order => order.customerId == customerId);
                    callback(customerOrders);
                });
            }
            
            function updateProductsTable() {
                const tableBody = document.getElementById('added-products-table');
                tableBody.innerHTML = '';
                
                let orderTotal = 0;
                
                customerProducts.forEach((product, index) => {
                    orderTotal += parseFloat(product.subtotal);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.productName}</td>
                        <td>${product.qty}</td>
                        <td>${product.unit}</td>
                        <td>${product.boatFee} (RF ${product.boatFeeAmount})</td>
                        <td>${product.tripNumber}</td>
                        <td>${product.date}</td>
                        <td>${product.time}</td>
                        <td>${product.description || '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-warning btn-xs edit-product" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-xs remove-product" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    
                    // Add event listener to remove button
                    row.querySelector('.remove-product').addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        customerProducts.splice(index, 1);
                        updateProductsTable();
                    });
                    
                    // Add event listener to edit button
                    row.querySelector('.edit-product').addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const product = customerProducts[index];
                        
                        // Fill the form with product data
                        document.getElementById('product-select').value = product.productId;
                        document.getElementById('product-unit').value = product.unit;
                        document.getElementById('product-qty-input').value = product.qty;
                        document.getElementById('product-desc-input').value = product.description || '';
                        document.getElementById('product-boat-fee').value = product.boatFee || '';
                        document.getElementById('payment-method').value = product.paymentMethod;
                        document.getElementById('product-date').value = product.date;
                        document.getElementById('product-time').value = product.time;
                        
                        // Remove the product from the list
                        customerProducts.splice(index, 1);
                        updateProductsTable();
                    });
                });
                
                document.getElementById('order-total').textContent = `Order Total: RF ${orderTotal.toFixed(2)}`;
                document.getElementById('product-list-table').style.display = 'block';
            }
            
            function loadCustomers(searchTerm = '') {
                const customerTableBody = document.getElementById('customer-table-body');
                const islandFilter = document.getElementById('pos-island').value;
                
                // Clear current table
                customerTableBody.innerHTML = '';
                
                // Get customers and orders from Firebase
                getCustomers((customers) => {
                    getOrders((orders) => {
                        // Filter by island if needed
                        let filteredCustomers = islandFilter === 'all' 
                            ? customers 
                            : customers.filter(customer => customer.island === islandFilter);
                        
                        // Filter by search term if provided
                        if (searchTerm) {
                            const term = searchTerm.toLowerCase();
                            filteredCustomers = filteredCustomers.filter(customer => 
                                customer.name.toLowerCase().includes(term) ||
                                customer.contact.toLowerCase().includes(term)
                            );
                        }
                        
                        if (filteredCustomers.length === 0) {
                            customerTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No customers found.</td></tr>';
                            return;
                        }
                        
                        // Create customer rows
                        filteredCustomers.forEach(customer => {
                            // Count orders for this customer
                            const customerOrders = orders.filter(order => order.customerId == customer.id);
                            const customerTotal = customerOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${customer.name}</td>
                                <td>${customer.contact}</td>
                                <td>${customer.island}</td>
                                <td>${customerOrders.length}</td>
                                <td>RF ${customerTotal.toFixed(2)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-primary btn-sm view-orders" data-id="${customer.id}" data-name="${customer.name}">
                                        <i class="fas fa-eye"></i> View Orders
                                    </button>
                                    <button class="btn btn-warning btn-sm edit-customer" data-id="${customer.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-customer" data-id="${customer.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            customerTableBody.appendChild(row);
                            
                            // Add event listener to view orders button
                            row.querySelector('.view-orders').addEventListener('click', function() {
                                const customerId = this.dataset.id;
                                const customerName = this.dataset.name;
                                showCustomerOrders(customerId, customerName);
                            });
                            
                            // Add event listener to edit customer button
                            row.querySelector('.edit-customer').addEventListener('click', function() {
                                const customerId = this.dataset.id;
                                editCustomer(customerId);
                            });
                            
                            // Add event listener to delete customer button
                            row.querySelector('.delete-customer').addEventListener('click', function() {
                                const customerId = this.dataset.id;
                                if (confirm('Are you sure you want to delete this customer?')) {
                                    deleteCustomer(customerId);
                                }
                            });
                        });
                    });
                });
            }
            
            function editCustomer(customerId) {
                database.ref('customers/' + customerId).once('value').then((snapshot) => {
                    const customer = snapshot.val();
                    if (customer) {
                        // Switch to form tab
                        document.querySelector('[data-tab="form"]').click();
                        
                        // Set island
                        document.getElementById('island').value = customer.island;
                        currentIsland = customer.island;
                        
                        // Show island customers
                        document.getElementById('island-customers').style.display = 'block';
                        document.getElementById('selected-island-name').textContent = customer.island;
                        loadIslandCustomers(customer.island);
                        
                        // Select the customer
                        selectCustomerForEntry(customerId);
                    }
                });
            }
            
            function deleteCustomer(customerId) {
                // First check if customer has orders
                getCustomerOrders(customerId, (orders) => {
                    if (orders.length > 0) {
                        alert('Cannot delete customer with existing orders. Please delete orders first.');
                        return;
                    }
                    
                    // Delete customer
                    database.ref('customers/' + customerId).remove().then(() => {
                        alert('Customer deleted successfully!');
                        loadCustomers();
                    });
                });
            }
            
            function showCustomerOrders(customerId, customerName) {
                const modal = document.getElementById('customer-orders-modal');
                const customerOrdersList = document.getElementById('customer-orders-list');
                const modalCustomerName = document.getElementById('modal-customer-name');
                
                modalCustomerName.textContent = `Orders for ${customerName}`;
                customerOrdersList.innerHTML = '<p>Loading orders...</p>';
                
                modal.style.display = 'block';
                
                getCustomerOrders(customerId, (orders) => {
                    if (orders.length === 0) {
                        customerOrdersList.innerHTML = '<p>No orders found for this customer.</p>';
                        return;
                    }
                    
                    customerOrdersList.innerHTML = '';
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.date).toLocaleDateString();
                        
                        const orderCard = document.createElement('div');
                        orderCard.className = 'trip-card';
                        orderCard.innerHTML = `
                            <div class="trip-header">
                                <div class="trip-date">${orderDate}</div>
                                <div class="trip-status ${order.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                    ${order.paymentStatus.toUpperCase()}
                                </div>
                            </div>
                            <div class="trip-products">
                                <strong>Trip Number:</strong> ${order.tripNumber}<br>
                                <strong>Payment Method:</strong> ${order.paymentMethod}<br>
                                <strong>Total Amount:</strong> RF ${order.totalAmount}<br>
                                <strong>Products:</strong>
                                <ul>
                                    ${order.products.map(product => `
                                        <li>${product.productName} - ${product.qty} ${product.unit} @ ${product.boatFee} (RF ${product.boatFeeAmount}) = RF ${product.subtotal}</li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="trip-actions">
                                <button class="btn btn-primary btn-sm generate-invoice" data-id="${order.id}">
                                    <i class="fas fa-file-pdf"></i> Generate Invoice
                                </button>
                                ${order.paymentStatus === 'unpaid' ? 
                                    `<button class="btn btn-success btn-sm mark-paid" data-id="${order.id}">
                                        <i class="fas fa-check"></i> Mark as Paid
                                    </button>` : 
                                    `<button class="btn btn-warning btn-sm mark-unpaid" data-id="${order.id}">
                                        <i class="fas fa-times"></i> Mark as Unpaid
                                    </button>`
                                }
                                <button class="btn btn-warning btn-sm add-more-products" data-id="${order.id}" data-customer="${customerId}">
                                    <i class="fas fa-plus"></i> Add More Products
                                </button>
                                <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">
                                    <i class="fas fa-trash"></i> Delete Order
                                </button>
                            </div>
                        `;
                        
                        customerOrdersList.appendChild(orderCard);
                        
                        // Add event listeners
                        orderCard.querySelector('.generate-invoice').addEventListener('click', function() {
                            generateOrderInvoice(order);
                        });
                        
                        if (order.paymentStatus === 'unpaid') {
                            orderCard.querySelector('.mark-paid').addEventListener('click', function() {
                                updateOrderPaymentStatus(order.id, 'paid');
                                alert('Order marked as paid!');
                                showCustomerOrders(customerId, customerName);
                            });
                        } else {
                            orderCard.querySelector('.mark-unpaid').addEventListener('click', function() {
                                updateOrderPaymentStatus(order.id, 'unpaid');
                                alert('Order marked as unpaid!');
                                showCustomerOrders(customerId, customerName);
                            });
                        }
                        
                        // Add more products to existing order
                        orderCard.querySelector('.add-more-products').addEventListener('click', function() {
                            const orderId = this.dataset.id;
                            const customerId = this.dataset.customer;
                            
                            // Switch to form tab
                            document.querySelector('[data-tab="form"]').click();
                            
                            // Load customer data
                            database.ref('customers/' + customerId).once('value').then((snapshot) => {
                                const customer = snapshot.val();
                                if (customer) {
                                    // Set island
                                    document.getElementById('island').value = customer.island;
                                    currentIsland = customer.island;
                                    
                                    // Show island customers
                                    document.getElementById('island-customers').style.display = 'block';
                                    document.getElementById('selected-island-name').textContent = customer.island;
                                    loadIslandCustomers(customer.island);
                                    
                                    // Select the customer
                                    selectCustomerForEntry(customerId);
                                    
                                    // Load order data
                                    database.ref('orders/' + orderId).once('value').then((snapshot) => {
                                        const order = snapshot.val();
                                        if (order) {
                                            // Set trip number
                                            document.getElementById('trip-number').value = order.tripNumber;
                                            tripNumber = order.tripNumber;
                                            currentOrderId = order.id;
                                            
                                            // Set products
                                            customerProducts = order.products;
                                            updateProductsTable();
                                            
                                            alert('You can now add more products to this order.');
                                        }
                                    });
                                }
                            });
                        });
                        
                        // Delete order
                        orderCard.querySelector('.delete-order').addEventListener('click', function() {
                            const orderId = this.dataset.id;
                            if (confirm('Are you sure you want to delete this order?')) {
                                database.ref('orders/' + orderId).remove().then(() => {
                                    alert('Order deleted successfully!');
                                    showCustomerOrders(customerId, customerName);
                                });
                            }
                        });
                    });
                });
            }
            
            function updateOrderPaymentStatus(orderId, status) {
                database.ref('orders/' + orderId + '/paymentStatus').set(status);
            }
            
            function generateOrderInvoice(order) {
                // Get customer details
                database.ref('customers/' + order.customerId).once('value').then((snapshot) => {
                    const customer = snapshot.val();
                    
                    const doc = new jsPDF();
                    
                    // Add logo and header
                    doc.setFontSize(20);
                    doc.setTextColor(26, 42, 108);
                    doc.text('NIYAAMAA BOAT', 105, 20, { align: 'center' });
                    doc.setFontSize(16);
                    doc.text('INVOICE', 105, 30, { align: 'center' });
                    
                    // Add invoice details
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Invoice ID: BT${order.id}`, 20, 45);
                    doc.text(`Date: ${new Date(order.date).toLocaleDateString()}`, 20, 52);
                    doc.text(`Time: ${new Date(order.date).toLocaleTimeString()}`, 20, 59);
                    doc.text(`Island: ${customer.island}`, 20, 66);
                    doc.text(`Trip Number: ${order.tripNumber}`, 20, 73);
                    
                    doc.text(`Customer: ${customer.name}`, 105, 45);
                    doc.text(`Contact: ${customer.contact}`, 105, 52);
                    doc.text(`Address: ${customer.address || ''}`, 105, 59);
                    doc.text(`Status: ${order.paymentStatus.toUpperCase()}`, 105, 66);
                    doc.text(`Payment Method: ${order.paymentMethod}`, 105, 73);
                    
                    // Add products table
                    const tableColumn = ["Product", "Unit", "Qty", "Boat Fee", "Fee Amount", "Subtotal"];
                    const tableRows = [];
                    
                    order.products.forEach(product => {
                        const productData = [
                            product.productName,
                            product.unit,
                            product.qty,
                            product.boatFee,
                            product.boatFeeAmount,
                            product.subtotal
                        ];
                        tableRows.push(productData);
                    });
                    
                    // Add total row
                    tableRows.push([
                        'TOTAL',
                        '',
                        '',
                        '',
                        '',
                        order.totalAmount
                    ]);
                    
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 90,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [26, 42, 108],
                            textColor: [255, 255, 255]
                        },
                        foot: [['TOTAL', '', '', '', '', order.totalAmount]],
                        footStyles: {
                            fillColor: [253, 187, 45],
                            textColor: [0, 0, 0]
                        }
                    });
                    
                    // Save the PDF
                    doc.save(`Invoice_BT${order.id}_${customer.name}.pdf`);
                });
            }
            
            // Load payments for payment management
            function loadPayments(filter) {
                const paymentList = document.getElementById('payment-list');
                const paymentTotal = document.getElementById('payment-total');
                
                // Clear current list
                paymentList.innerHTML = '';
                
                let totalValue = 0;
                
                // Get orders and customers from Firebase
                getOrders((orders) => {
                    getCustomers((customers) => {
                        // Filter orders based on payment status
                        let filteredOrders = orders;
                        if (filter !== 'all') {
                            filteredOrders = orders.filter(order => order.paymentStatus === filter);
                        }
                        
                        if (filteredOrders.length === 0) {
                            paymentList.innerHTML = '<p>No payments found.</p>';
                            paymentTotal.textContent = 'Total Value: RF 0';
                            return;
                        }
                        
                        // Create payment items
                        filteredOrders.forEach(order => {
                            const customer = customers.find(c => c.id == order.customerId);
                            
                            if (!customer) return;
                            
                            totalValue += parseFloat(order.totalAmount || 0);
                            
                            const paymentItem = document.createElement('div');
                            paymentItem.className = 'payment-item';
                            
                            // Format date
                            const orderDate = new Date(order.date).toLocaleDateString();
                            
                            paymentItem.innerHTML = `
                                <div class="payment-info">
                                    <p><strong>${customer.name}</strong> - ${customer.island} (${orderDate})</p>
                                    <p>Trip: ${order.tripNumber}</p>
                                    <p>${order.products.length} products</p>
                                    <p>Payment Method: ${order.paymentMethod}</p>
                                </div>
                                <div class="payment-amount">
                                    RF ${order.totalAmount}
                                </div>
                                <div class="payment-actions">
                                    <span class="trip-status ${order.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                        ${order.paymentStatus.toUpperCase()}
                                    </span>
                                    <button class="btn btn-primary btn-sm view-payment" data-id="${order.id}">View</button>
                                </div>
                            `;
                            
                            paymentList.appendChild(paymentItem);
                            
                            // Add event listener to view button
                            paymentItem.querySelector('.view-payment').addEventListener('click', function() {
                                // Switch to POS tab and show the customer orders
                                document.querySelector('[data-tab="pos"]').click();
                                showCustomerOrders(order.customerId, customer.name);
                            });
                        });
                        
                        paymentTotal.textContent = `Total Value: RF ${totalValue.toFixed(2)}`;
                    });
                });
            }
            
            // Update dashboard with statistics
            function updateDashboard() {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                getOrders((orders) => {
                    // Filter orders by date if dates are selected
                    let filteredOrders = orders;
                    if (startDate && endDate) {
                        filteredOrders = orders.filter(order => {
                            const orderDate = new Date(order.date);
                            const start = new Date(startDate);
                            const end = new Date(endDate);
                            end.setDate(end.getDate() + 1); // Include end date
                            return orderDate >= start && orderDate <= end;
                        });
                    }
                    
                    // Calculate totals
                    let totalProducts = 0;
                    let totalBoatFees = 0;
                    let totalOrders = filteredOrders.length;
                    let totalRevenue = 0;
                    let pendingBills = 0;
                    
                    // Count products and revenue
                    filteredOrders.forEach(order => {
                        if (order.paymentStatus === 'unpaid') {
                            pendingBills += parseFloat(order.totalAmount) || 0;
                        } else {
                            totalRevenue += parseFloat(order.totalAmount) || 0;
                        }
                        order.products.forEach(product => {
                            totalProducts += parseInt(product.qty) || 0;
                            if (product.boatFee) totalBoatFees++;
                        });
                    });
                    
                    // Update dashboard values
                    document.getElementById('total-products').textContent = totalProducts;
                    document.getElementById('total-boatfees').textContent = totalBoatFees;
                    document.getElementById('total-orders').textContent = totalOrders;
                    document.getElementById('total-revenue').textContent = 'RF ' + totalRevenue.toFixed(2);
                    document.getElementById('pending-bills').textContent = 'RF ' + pendingBills.toFixed(2);
                    
                    // Update charts
                    updateProductsChart(filteredOrders);
                    updateIslandsChart(filteredOrders);
                    updatePaymentMethodsChart(filteredOrders);
                });
            }
            
            function updateProductsChart(orders) {
                // Count products by type
                const productCounts = {};
                
                orders.forEach(order => {
                    order.products.forEach(product => {
                        if (!productCounts[product.productName]) {
                            productCounts[product.productName] = 0;
                        }
                        productCounts[product.productName] += parseInt(product.qty) || 0;
                    });
                });
                
                const ctx = document.getElementById('products-chart').getContext('2d');
                
                // Destroy previous chart if it exists
                if (productsChart) {
                    productsChart.destroy();
                }
                
                productsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(productCounts),
                        datasets: [{
                            label: 'Products Delivered',
                            data: Object.values(productCounts),
                            backgroundColor: [
                                'rgba(26, 42, 108, 0.7)',
                                'rgba(178, 31, 31, 0.7)',
                                'rgba(253, 187, 45, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(23, 162, 184, 0.7)',
                                'rgba(108, 117, 125, 0.7)'
                        ],
                            borderColor: [
                                'rgba(26, 42, 108, 1)',
                                'rgba(178, 31, 31, 1)',
                                'rgba(253, 187, 45, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(108, 117, 125, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            function updateIslandsChart(orders) {
                // Count orders by island
                const islandCounts = {};
                
                orders.forEach(order => {
                    // Get customer island
                    database.ref('customers/' + order.customerId).once('value').then((snapshot) => {
                        const customer = snapshot.val();
                        if (customer && customer.island) {
                            if (!islandCounts[customer.island]) {
                                islandCounts[customer.island] = 0;
                            }
                            islandCounts[customer.island] += 1;
                            
                            // Update chart when all data is processed
                            if (Object.keys(islandCounts).length > 0) {
                                const ctx = document.getElementById('islands-chart').getContext('2d');
                                
                                // Destroy previous chart if it exists
                                if (islandsChart) {
                                    islandsChart.destroy();
                                }
                                
                                islandsChart = new Chart(ctx, {
                                    type: 'pie',
                                    data: {
                                        labels: Object.keys(islandCounts),
                                        datasets: [{
                                            label: 'Orders by Island',
                                            data: Object.values(islandCounts),
                                            backgroundColor: [
                                                'rgba(26, 42, 108, 0.7)',
                                                'rgba(178, 31, 31, 0.7)',
                                                'rgba(253, 187, 45, 0.7)',
                                                'rgba(40, 167, 69, 0.7)',
                                                'rgba(23, 162, 184, 0.7)',
                                                'rgba(108, 117, 125, 0.7)'
                                            ],
                                            borderColor: [
                                                'rgba(26, 42, 108, 1)',
                                                'rgba(178, 31, 31, 1)',
                                                'rgba(253, 187, 45, 1)',
                                                'rgba(40, 167, 69, 1)',
                                                'rgba(23, 162, 184, 1)',
                                                'rgba(108, 117, 125, 1)'
                                            ],
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true
                                    }
                                });
                            }
                        }
                    });
                });
            }
            
            function updatePaymentMethodsChart(orders) {
                // Count payment methods
                const paymentMethods = {
                    'cash': 0,
                    'transfer': 0,
                    'card': 0,
                    'not-paid': 0
                };
                
                orders.forEach(order => {
                    if (order.paymentMethod && paymentMethods.hasOwnProperty(order.paymentMethod)) {
                        paymentMethods[order.paymentMethod] += 1;
                    }
                });
                
                const ctx = document.getElementById('payment-methods-chart').getContext('2d');
                
                // Destroy previous chart if it exists
                if (paymentMethodsChart) {
                    paymentMethodsChart.destroy();
                }
                
                paymentMethodsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cash', 'Transfer', 'Card', 'Not Paid'],
                        datasets: [{
                            label: 'Payment Methods',
                            data: [
                                paymentMethods['cash'],
                                paymentMethods['transfer'],
                                paymentMethods['card'],
                                paymentMethods['not-paid']
                            ],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(23, 162, 184, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
        });
    </script>
</body>
</html>